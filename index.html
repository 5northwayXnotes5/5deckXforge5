<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DeckOS</title>
<!-- Phosphor Icons -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
/* --- SYSTEM VARIABLES --- */
:root {
  --bg-os: #000;
  --app-bg: #121212;
  --panel-bg: #1c1c1e;
  --dock-bg: rgba(20, 20, 20, 0.65);
  --text-primary: #fff;
  --text-sec: #8e8e93;
  --separator: #38383a;
  
  --accent-blue: #0A84FF;
  --accent-green: #30D158;
  --accent-red: #FF453A;
  --accent-orange: #FF9F0A;
  --accent-purple: #BF5AF2;
  --accent-gold: #FFD60A;
  
  --icon-size: 64px;
  --icon-radius: 16px;
  
  --font-sys: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
html, body { height: 100%; width: 100%; overflow: hidden; margin: 0; background: #000; font-family: var(--font-sys); color: white; }

/* --- WALLPAPER --- */
#wallpaper {
  position: absolute; inset: -20px; z-index: 1;
  background: radial-gradient(circle at 50% 30%, #2b32b2, #1488cc); /* Deep Blue */
  background-size: cover; background-position: center;
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.4s;
}
body.app-open #wallpaper { transform: scale(1.1); filter: blur(20px) brightness(0.5); }

/* --- STATUS BAR --- */
#status-bar {
  position: absolute; top: 0; left: 0; right: 0; height: 50px; z-index: 100;
  display: flex; justify-content: space-between; align-items: flex-end;
  padding: 0 24px 10px; font-size: 14px; font-weight: 600;
  color: white; pointer-events: none; text-shadow: 0 1px 4px rgba(0,0,0,0.3);
}
.currency-pill {
  background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
  padding: 4px 12px; border-radius: 20px;
  display: flex; align-items: center; gap: 6px;
  font-size: 13px; border: 1px solid rgba(255,255,255,0.1);
}

/* --- APP ICONS --- */
.app-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); 
  gap: 24px 16px; padding: 20px 24px; margin-top: 60px; z-index: 10; position: relative;
  transition: opacity 0.3s, transform 0.3s;
}
body.app-open .app-grid { opacity: 0; pointer-events: none; transform: scale(1.1); }

.app-item { display: flex; flex-direction: column; align-items: center; gap: 8px; cursor: pointer; transition: transform 0.1s; }
.app-item:active { transform: scale(0.95); opacity: 0.8; }

.icon-box {
  width: var(--icon-size); height: var(--icon-size);
  border-radius: var(--icon-radius);
  display: flex; align-items: center; justify-content: center;
  font-size: 32px; color: white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  position: relative; overflow: hidden;
  background-size: 150% 150%;
}
.icon-box i { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
.app-name { font-size: 11px; font-weight: 500; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

/* Gradients */
.grad-duel { background: linear-gradient(135deg, #ff416c, #ff4b2b); }
.grad-royale { background: linear-gradient(135deg, #654ea3, #eaafc8); }
.grad-dice { background: linear-gradient(135deg, #11998e, #38ef7d); }
.grad-mem { background: linear-gradient(135deg, #f2994a, #f2c94c); }
.grad-press { background: linear-gradient(135deg, #232526, #414345); border: 1px solid rgba(255,255,255,0.1); }
.grad-cards { background: linear-gradient(135deg, #2193b0, #6dd5ed); }
.grad-lab { background: linear-gradient(135deg, #56ab2f, #a8e063); }
.grad-store { background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045); }
.grad-set { background: linear-gradient(135deg, #304352, #d7d2cc); }

/* --- DOCK --- */
.dock-container {
  position: absolute; bottom: 30px; left: 16px; right: 16px;
  height: 96px; z-index: 10;
  background: var(--dock-bg);
  backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border-radius: 34px;
  display: flex; align-items: center; justify-content: space-evenly;
  border: 1px solid rgba(255,255,255,0.1);
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
}
body.app-open .dock-container { transform: translateY(200%); }

/* --- APP WINDOW --- */
.app-window {
  position: absolute; inset: 0; background: var(--app-bg);
  display: none; flex-direction: column;
  opacity: 0; transform: scale(0.9);
  transition: opacity 0.3s, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  pointer-events: auto; z-index: 50;
}
.app-window.active { display: flex; opacity: 1; transform: scale(1); }

.nav-bar {
  height: 100px; padding: 50px 20px 10px;
  display: flex; align-items: flex-end; justify-content: space-between;
  background: rgba(28,28,30,0.8); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--separator); flex-shrink: 0;
}
.nav-title { font-size: 34px; font-weight: 700; color: white; line-height: 1; }
.nav-gold { font-size: 16px; font-weight: 600; color: var(--accent-gold); display: flex; align-items: center; gap: 4px; }

.content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 40px; }

/* --- LISTS & INPUTS --- */
.list-group { margin: 24px 16px; background: var(--panel-bg); border-radius: 12px; overflow: hidden; }
.list-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 14px 16px; border-bottom: 0.5px solid var(--separator);
  font-size: 16px; color: white;
}
.list-row:last-child { border-bottom: none; }
.list-row label { font-weight: 500; }
select, input { background: transparent; border: none; color: var(--accent-blue); font-size: 16px; text-align: right; width: 60%; font-family: inherit; }
select:focus, input:focus { outline: none; }

.btn {
  background: var(--panel-bg); color: var(--accent-blue);
  font-size: 17px; font-weight: 600; padding: 14px;
  border-radius: 12px; margin: 10px 16px; text-align: center; cursor: pointer;
  transition: 0.1s;
}
.btn:active { background: #2c2c2e; transform: scale(0.98); }
.btn.filled { background: var(--accent-blue); color: white; box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3); }
.btn.gold { background: var(--accent-gold); color: black; box-shadow: 0 4px 12px rgba(255, 214, 10, 0.3); }
.btn.danger { color: var(--accent-red); }

/* --- GAME ELEMENTS --- */
/* Shop */
.shop-grid { display: grid; grid-template-columns: 1fr; gap: 20px; padding: 20px; }
.shop-item {
  background: var(--panel-bg); border-radius: 16px; padding: 20px;
  display: flex; align-items: center; gap: 20px; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden;
}
.shop-item:active { transform: scale(0.98); }
.pack-icon {
  width: 60px; height: 80px; border-radius: 8px;
  background: linear-gradient(135deg, #444, #222);
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; color: white;
}
.pack-basic .pack-icon { background: linear-gradient(135deg, #a8e063, #56ab2f); }
.pack-elite .pack-icon { background: linear-gradient(135deg, #4facfe, #00f2fe); }
.pack-supreme .pack-icon { background: linear-gradient(135deg, #FFD60A, #f12711); box-shadow: 0 0 15px rgba(255, 214, 10, 0.4); }

/* Duel */
.game-stage {
  margin: 16px; padding: 20px;
  background: var(--panel-bg); border-radius: 20px;
  display: flex; flex-direction: column; align-items: center;
}
.duel-slots { display: flex; gap: 20px; margin: 20px 0; }
.card-slot { width: 100px; height: 150px; background: rgba(0,0,0,0.3); border: 2px dashed #444; border-radius: 12px; overflow: hidden; }
.card-strip { display: flex; overflow-x: auto; gap: 12px; padding: 0 16px 20px; }
.strip-card { width: 70px; height: 100px; border-radius: 8px; flex-shrink: 0; background: #333; }

/* Pressure */
.pressure-card {
  width: 200px; height: 300px; border-radius: 16px; background: #222;
  margin: 20px auto; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  position: relative; transition: transform 0.1s;
}
.pressure-card img { width: 100%; height: 100%; object-fit: cover; }
.multiplier-disp { font-size: 48px; font-weight: 800; color: var(--accent-gold); text-align: center; margin: 10px 0; }

/* --- OVERLAYS --- */
#home-bar {
  position: fixed; bottom: 0; left: 0; right: 0; height: 30px; z-index: 9999;
  display: flex; justify-content: center; align-items: center; cursor: pointer;
}
.bar-pill { width: 130px; height: 5px; background: white; border-radius: 3px; opacity: 0.6; }

.modal {
  position: fixed; inset: 0; z-index: 200; background: #000;
  display: none; align-items: center; justify-content: center; flex-direction: column;
}
.modal.active { display: flex; }

.pack-open-anim { width: 220px; height: 320px; border-radius: 20px; background: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: 900; color: #000; box-shadow: 0 0 100px rgba(255,255,255,0.5); animation: shake 0.5s ease-in-out infinite; cursor: pointer; }
@keyframes shake{ 0%,100%{transform:rotate(0);} 25%{transform:rotate(5deg);} 75%{transform:rotate(-5deg);} }

.card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 16px; }
.card-thumb { aspect-ratio: 2/3; background: #333; border-radius: 8px; position: relative; overflow: hidden; }
.card-thumb img { width: 100%; height: 100%; object-fit: cover; }
.rarity-tag { position: absolute; bottom: 0; left: 0; right: 0; height: 6px; }

/* Toast */
.toast {
  position: fixed; top: -80px; left: 16px; right: 16px; height: 60px;
  background: rgba(30, 30, 30, 0.9); backdrop-filter: blur(20px);
  border-radius: 16px; z-index: 500; display: flex; align-items: center; padding: 0 16px; gap: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}
.toast.show { top: 60px; }
.toast i { font-size: 24px; color: var(--accent-gold); }

.hidden { display: none !important; }
</style>
</head>
<body>

<div id="wallpaper"></div>

<div id="status-bar">
  <div id="clock">9:41</div>
  <div class="currency-pill">
    <i class="ph-fill ph-coins" style="color:var(--accent-gold)"></i>
    <span id="gold-display">500</span>
  </div>
  <div>
    <i class="ph-bold ph-wifi-high"></i>
    <i class="ph-bold ph-battery-full" style="margin-left:6px;"></i>
  </div>
</div>

<!-- HOME SCREEN -->
<div class="app-grid">
  <div class="app-item" onclick="app.open('duel')">
    <div class="icon-box grad-duel"><i class="ph-fill ph-sword"></i></div>
    <div class="app-name">Duel</div>
  </div>
  <div class="app-item" onclick="app.open('royale')">
    <div class="icon-box grad-royale"><i class="ph-fill ph-crown"></i></div>
    <div class="app-name">Royale</div>
  </div>
  <div class="app-item" onclick="app.open('dice')">
    <div class="icon-box grad-dice"><i class="ph-fill ph-dice-five"></i></div>
    <div class="app-name">Dice</div>
  </div>
  <div class="app-item" onclick="app.open('memory')">
    <div class="icon-box grad-mem"><i class="ph-fill ph-brain"></i></div>
    <div class="app-name">Memory</div>
  </div>
  <div class="app-item" onclick="app.open('pressure')">
    <div class="icon-box grad-press"><i class="ph-fill ph-gauge"></i></div>
    <div class="app-name">Pressure</div>
  </div>
</div>

<!-- DOCK -->
<div class="dock-container">
  <div class="app-item" onclick="app.open('collection')">
    <div class="icon-box grad-cards"><i class="ph-fill ph-cards"></i></div>
  </div>
  <div class="app-item" onclick="app.open('lab')">
    <div class="icon-box grad-lab"><i class="ph-fill ph-flask"></i></div>
  </div>
  <div class="app-item" onclick="app.open('shop')">
    <div class="icon-box grad-store"><i class="ph-fill ph-shopping-bag"></i></div>
  </div>
  <div class="app-item" onclick="app.open('settings')">
    <div class="icon-box grad-set"><i class="ph-fill ph-gear"></i></div>
  </div>
</div>

<!-- APPS -->
<div id="app-layer">

  <!-- DUEL -->
  <div id="app-duel" class="app-window">
    <div class="nav-bar">
      <div class="nav-title">Duel</div>
      <div class="nav-gold"><i class="ph-fill ph-coins"></i> +50</div>
    </div>
    <div class="content">
      <div class="game-stage">
        <div style="font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;" id="duel-round">Round 1</div>
        <div style="display:flex; justify-content:space-between; width:100%; padding:0 40px; font-size:32px; font-weight:800;">
          <span style="color:var(--accent-green)" id="score-you">0</span>
          <span style="color:var(--accent-red)" id="score-ai">0</span>
        </div>
        <div class="duel-slots">
          <div class="card-slot" id="slot-you"></div>
          <div style="display:flex; align-items:center; opacity:0.3; font-weight:900;">VS</div>
          <div class="card-slot" id="slot-ai"></div>
        </div>
        <div id="duel-msg" style="height:20px; color:var(--accent-orange); font-weight:600;"></div>
      </div>
      <div class="list-group">
        <div class="list-row">
          <label>Deck</label>
          <select id="duel-deck-filter" onchange="app.filterDuel()"><option value="">All Cards</option></select>
        </div>
      </div>
      <div class="card-strip" id="duel-strip"></div>
      <div class="btn filled" id="btn-duel-fight" onclick="app.resolveDuel()">FIGHT</div>
    </div>
  </div>

  <!-- SHOP -->
  <div id="app-shop" class="app-window">
    <div class="nav-bar"><div class="nav-title">Store</div><div class="nav-gold" id="shop-gold">500</div></div>
    <div class="content">
      <div class="shop-grid">
        <div class="shop-item pack-basic" onclick="app.buyPack('basic', 100)">
          <div class="pack-icon"><i class="ph-fill ph-package"></i></div>
          <div style="flex:1">
            <div style="font-weight:700; font-size:18px;">Basic Pack</div>
            <div style="font-size:13px; color:#888;">Standard cards.</div>
          </div>
          <div class="btn gold sm" style="margin:0;">100 G</div>
        </div>
        <div class="shop-item pack-elite" onclick="app.buyPack('elite', 500)">
          <div class="pack-icon"><i class="ph-fill ph-star"></i></div>
          <div style="flex:1">
            <div style="font-weight:700; font-size:18px;">Elite Pack</div>
            <div style="font-size:13px; color:#888;">Better odds.</div>
          </div>
          <div class="btn gold sm" style="margin:0;">500 G</div>
        </div>
        <div class="shop-item pack-supreme" onclick="app.buyPack('supreme', 2000)">
          <div class="pack-icon"><i class="ph-fill ph-crown"></i></div>
          <div style="flex:1">
            <div style="font-weight:700; font-size:18px; color:var(--accent-gold);">Supreme</div>
            <div style="font-size:13px; color:#888;">High tier loot.</div>
          </div>
          <div class="btn gold sm" style="margin:0;">2K G</div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRESSURE (BETTING) -->
  <div id="app-pressure" class="app-window">
    <div class="nav-bar"><div class="nav-title">Pressure</div></div>
    <div class="content" style="display:flex; flex-direction:column;">
      <div class="game-stage" style="flex:1; justify-content:center;">
        <div id="pressure-lobby">
           <div style="text-align:center; margin-bottom:20px; font-size:18px; color:#aaa;">Place your bet. Survive to multiply.</div>
           <div class="list-group">
             <div class="list-row"><label>Bet Amount</label><input type="number" id="pressure-bet" value="50"></div>
           </div>
           <div class="btn gold" onclick="app.startPressure()">START RUN (-Bet)</div>
        </div>
        
        <div id="pressure-game" class="hidden" style="width:100%;">
           <div class="multiplier-disp" id="p-multi">1.00x</div>
           <div class="pressure-card" id="p-card-view"></div>
           <div style="height:10px; background:#333; border-radius:5px; margin:20px 0; overflow:hidden;">
             <div id="p-bar" style="height:100%; width:50%; background:var(--accent-red);"></div>
           </div>
           <div class="btn filled" onmousedown="app.pressureTap()" ontouchstart="app.pressureTap()" style="height:80px; font-size:24px; display:flex; align-items:center; justify-content:center;">TAP</div>
           <div class="btn gold" onclick="app.cashOut()">CASH OUT</div>
        </div>
      </div>
    </div>
  </div>

  <!-- COLLECTION -->
  <div id="app-collection" class="app-window">
    <div class="nav-bar"><div class="nav-title">Cards</div></div>
    <div class="content">
      <div class="card-grid" id="col-grid"></div>
      <div id="col-empty" style="text-align:center; margin-top:50px; color:#666;">No cards. Visit Store.</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="app-settings" class="app-window">
    <div class="nav-bar"><div class="nav-title">Settings</div></div>
    <div class="content">
      <div class="list-group">
         <div class="list-row"><label>Wallpaper</label><input id="wall-in" placeholder="URL"></div>
         <div class="btn" onclick="app.setWall()">Set</div>
      </div>
      <div class="list-group">
         <div class="list-row"><label>Custom Stat</label><input id="stat-in"></div>
         <div class="btn" onclick="app.addStat()">Add</div>
         <div id="stat-list"></div>
      </div>
      <div class="list-group">
         <div class="list-row"><textarea id="pool-in" style="width:100%; height:80px; background:transparent; border:none; color:white; font-size:12px;" placeholder="[Name]URL"></textarea></div>
         <div class="btn" onclick="app.parsePool()">Update Pool</div>
         <div class="btn" onclick="app.loadDemo()">Load Demo Data</div>
      </div>
      <div class="btn danger" onclick="app.wipe()">Factory Reset</div>
    </div>
  </div>

  <!-- LAB -->
  <div id="app-lab" class="app-window">
    <div class="nav-bar"><div class="nav-title">Lab</div></div>
    <div class="content">
      <div class="list-group">
        <div class="list-row"><input id="deck-name" placeholder="Deck Name"><div class="btn sm" onclick="app.saveDeck()">Save</div></div>
        <div class="list-row"><label>Active Deck</label><select id="deck-sel" onchange="app.selDeck(this.value)"></select></div>
      </div>
      <div class="list-group">
        <div class="list-row"><select id="fuse-a"><option>Card A</option></select></div>
        <div class="list-row"><select id="fuse-b"><option>Card B</option></select></div>
      </div>
      <div class="btn filled" onclick="app.fuse()">FUSE</div>
    </div>
  </div>
  
  <!-- ROYALE, DICE, MEMORY (Standard Apps) -->
  <div id="app-royale" class="app-window">
    <div class="nav-bar"><div class="nav-title">Royale</div></div>
    <div class="content">
      <div class="list-group">
        <div class="list-row"><label>Pool</label><select id="royale-src"><option value="all">All</option><option value="deck">Deck</option></select></div>
      </div>
      <div class="btn filled" onclick="app.runRoyale()">Simulate</div>
      <div id="royale-log" style="padding:20px; font-family:monospace; font-size:12px; color:#888;"></div>
    </div>
  </div>
  
  <div id="app-dice" class="app-window">
    <div class="nav-bar"><div class="nav-title">Dice</div></div>
    <div class="content">
       <div class="game-stage">
          <div style="display:flex; gap:30px; font-size:40px; font-weight:800;">
             <div id="dice-p">?</div><div style="opacity:0.3">vs</div><div id="dice-ai">?</div>
          </div>
          <div id="dice-res" style="margin-top:20px; color:var(--accent-gold);">Streak: 0</div>
       </div>
       <div class="btn filled" id="dice-btn" onclick="app.rollDice()" disabled>Roll</div>
       <div class="list-group"><div class="list-row" onclick="app.pickDice()">Select Card for Bonus</div></div>
    </div>
  </div>

  <div id="app-memory" class="app-window">
    <div class="nav-bar"><div class="nav-title">Memory</div><button class="btn sm" onclick="app.initMem()">Reset</button></div>
    <div class="content">
       <div class="card-grid" style="grid-template-columns:repeat(4,1fr)" id="mem-grid"></div>
    </div>
  </div>

</div>

<!-- GLOBAL OVERLAYS -->
<div id="home-bar" onclick="app.home()"><div class="bar-pill"></div></div>

<div class="modal" id="pack-modal">
   <div class="pack-open-anim" id="pack-opener">TAP</div>
   <div class="card-grid" id="pack-reveal" style="grid-template-columns:repeat(2,1fr); width:100%; max-width:400px; margin-top:20px;"></div>
   <div class="btn" id="pack-done" onclick="app.closePack()" style="display:none; margin-top:30px; width:200px;">Done</div>
</div>

<div class="modal" id="sheet-modal" style="background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); justify-content:flex-end; align-items:stretch;">
   <div style="background:#1c1c1e; border-radius:20px 20px 0 0; padding:24px; animation:slideUp 0.3s;">
      <div style="display:flex; gap:16px;">
         <div id="sheet-img" style="width:100px; height:150px; background:#333; border-radius:10px; overflow:hidden;"></div>
         <div style="flex:1">
            <h2 id="sheet-name" style="margin:0 0 8px 0;">Name</h2>
            <div id="sheet-stats" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
         </div>
      </div>
      <div class="btn filled" id="btn-deck-tog" onclick="app.togDeck()">Add to Deck</div>
      <div class="btn danger" onclick="app.delCard()">Delete</div>
      <div class="btn" onclick="app.closeSheet()">Close</div>
   </div>
</div>

<div class="toast" id="toast">
  <i class="ph-fill ph-bell"></i>
  <span id="toast-msg">Notification</span>
</div>

<style> @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}} </style>

<script>
const app = (function(){
  const DEF = {
    ver: 3,
    gold: 500,
    pool: [], col: [], decks: [], stats: ['ATK','DEF','SPD'],
    rarity: [
      {id:'c',n:'Common',c:'#8e8e93',w:60}, {id:'u',n:'Uncommon',c:'#30d158',w:30},
      {id:'r',n:'Rare',c:'#0a84ff',w:15}, {id:'e',n:'Epic',c:'#bf5af2',w:5},
      {id:'l',n:'Legend',c:'#ffd60a',w:1}
    ],
    wall: ''
  };
  let s = JSON.parse(JSON.stringify(DEF));
  
  // Game States
  let duel={a:false,r:1,ps:0,as:0,u:[],sel:null,deck:null};
  let press={a:false,l:null,bet:0,mul:1,pos:50,card:null};
  let mem={l:false,g:[],f:null,c:0};
  let dice={c:null,s:0};
  let curC=null, curD=null;

  const $ = id => document.getElementById(id);
  const uid = () => Math.random().toString(36).slice(2);
  const rand = a => a[Math.floor(Math.random()*a.length)];
  const notify = m => { $('toast-msg').innerText=m; $('toast').classList.add('show'); setTimeout(()=>$('toast').classList.remove('show'),3000); };
  
  function save(){ localStorage.setItem('dos_v3', JSON.stringify(s)); ui(); }
  function ui(){ 
    $('gold-display').innerText = s.gold; $('shop-gold').innerText = s.gold;
    $('col-empty').style.display = s.col.length ? 'none':'block';
  }

  function init(){
    const l = localStorage.getItem('dos_v3');
    if(l) { const p=JSON.parse(l); if(p.ver===3) s=p; else { s.pool=p.pool||[]; s.col=p.collection||[]; s.gold=500; } }
    if(s.wall) $('wallpaper').style.backgroundImage = `url('${s.wall}')`;
    setInterval(()=>{ const d=new Date(); $('clock').innerText=`${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; },1000);
    ui();
  }

  function open(id){
    document.querySelectorAll('.app-window').forEach(e=>e.classList.remove('active'));
    $(`app-${id}`).classList.add('active');
    document.body.classList.add('app-open');
    if(id==='duel') initDuel();
    if(id==='collection') renderCol();
    if(id==='lab') initLab();
    if(id==='settings') initSet();
    if(id==='memory') initMem();
    if(id==='dice') { dice.s=0; dice.c=null; $('dice-btn').disabled=true; }
  }
  function home(){ 
    document.querySelectorAll('.app-window').forEach(e=>e.classList.remove('active'));
    document.body.classList.remove('app-open');
    if(press.l) clearInterval(press.l);
  }

  // LOGIC
  function createCard(tid, rid){
    const t = s.pool.find(x=>x.id===tid);
    if(!t) return null;
    const r = s.rarity.find(x=>x.id===rid) || s.rarity[0];
    const stat = {};
    s.stats.forEach(k => stat[k] = Math.floor(Math.random()*100 * (s.rarity.indexOf(r)+1)));
    return { id:uid(), tid, rid, stat };
  }
  
  function getDrop(tier){
    if(!s.pool.length) return null;
    const t = rand(s.pool);
    const r = Math.random();
    let rid = 'c';
    if(tier==='basic') rid = r<0.7?'c':(r<0.95?'u':'r');
    if(tier==='elite') rid = r<0.4?'u':(r<0.8?'r':(r<0.95?'e':'l'));
    if(tier==='supreme') rid = r<0.3?'r':(r<0.7?'e':'l');
    return createCard(t.id, rid);
  }

  // SHOP
  function buyPack(tier, cost){
    if(s.gold < cost) return notify("Insufficient Funds");
    s.gold -= cost; save();
    $('pack-modal').classList.add('active');
    $('pack-opener').style.display = 'flex'; $('pack-reveal').innerHTML=''; $('pack-done').style.display='none';
    $('pack-opener').onclick = () => {
       $('pack-opener').style.display='none';
       const cards = []; for(let i=0; i<3; i++) { const c=getDrop(tier); if(c) cards.push(c); }
       if(!cards.length) return notify("Pool Empty");
       s.col.push(...cards); save();
       cards.forEach(c => {
         const t=s.pool.find(x=>x.id===c.tid); const r=s.rarity.find(x=>x.id===c.rid);
         const d=document.createElement('div'); d.className='card-thumb';
         d.innerHTML=`<img src="${t.img}"><div class="rarity-tag" style="background:${r.c}"></div>`;
         $('pack-reveal').appendChild(d);
       });
       $('pack-done').style.display='block';
    }
  }
  function closePack(){ $('pack-modal').classList.remove('active'); }

  // DUEL
  function initDuel(){ 
    const sel=$('duel-deck-filter'); sel.innerHTML='<option value="">All Cards</option>';
    s.decks.forEach(d=>sel.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
    duel.u=[]; duel.r=1; duel.ps=0; duel.as=0; duel.deck=null; duel.sel=null;
    renderDuel(); renderDuelStrip();
  }
  function filterDuel(){ duel.deck = $('duel-deck-filter').value; renderDuelStrip(); }
  function renderDuel(){
    $('score-you').innerText = duel.ps; $('score-ai').innerText = duel.as; $('duel-round').innerText = `Round ${duel.r}`;
    $('slot-you').innerHTML = duel.sel ? `<img src="${s.pool.find(x=>x.id===duel.sel.tid).img}" style="width:100%;height:100%;object-fit:cover;">` : '';
    $('slot-ai').innerHTML = '';
  }
  function renderDuelStrip(){
    const b = $('duel-strip'); b.innerHTML = '';
    let pool = s.col.filter(c=>!duel.u.includes(c.id));
    if(duel.deck) { const d=s.decks.find(x=>x.id===duel.deck); if(d) pool=pool.filter(c=>d.cards.includes(c.id)); }
    pool.forEach(c => {
      const t = s.pool.find(x=>x.id===c.tid);
      const d = document.createElement('div'); d.className='strip-card';
      d.innerHTML = `<img src="${t.img}" style="width:100%;height:100%;object-fit:cover;border-radius:8px;">`;
      d.onclick = () => { duel.sel = c; renderDuel(); }
      b.appendChild(d);
    });
  }
  function resolveDuel(){
    if(!duel.sel) return;
    duel.u.push(duel.sel.id);
    const ai = createCard(rand(s.pool).id, 'r');
    $('slot-ai').innerHTML = `<img src="${s.pool.find(x=>x.id===ai.tid).img}" style="width:100%;height:100%;object-fit:cover;">`;
    const stat = rand(s.stats);
    const pV = duel.sel.stat[stat]; const aV = ai.stat[stat];
    if(pV > aV) { duel.ps++; $('duel-msg').innerText = "WIN"; } else { duel.as++; $('duel-msg').innerText = "LOSS"; }
    duel.sel=null; 
    setTimeout(() => {
       duel.r++; if(duel.r > 3) {
         if(duel.ps > duel.as) { s.gold += 50; notify("Won 50G"); } else notify("Defeat");
         initDuel();
       } else { renderDuel(); renderDuelStrip(); $('duel-msg').innerText=""; }
       save();
    }, 1500);
  }

  // PRESSURE
  function startPressure(){
    if(!s.col.length) return notify("No Cards");
    const bet = parseInt($('pressure-bet').value);
    if(s.gold < bet) return notify("Need Gold");
    s.gold -= bet; save();
    press = {a:true, l:null, bet, mul:1.0, pos:50, card:rand(s.col)};
    $('pressure-lobby').classList.add('hidden'); $('pressure-game').classList.remove('hidden');
    $('p-card-view').innerHTML = `<img src="${s.pool.find(x=>x.id===press.card.tid).img}">`;
    press.l = setInterval(()=>{
      press.pos -= 0.5; press.mul += 0.01;
      $('p-bar').style.width = press.pos+'%'; $('p-multi').innerText = press.mul.toFixed(2)+'x';
      if(press.pos <= 0) { clearInterval(press.l); notify("CRASHED!"); home(); resetPress(); }
    }, 50);
  }
  function pressureTap(){ if(press.a && press.pos < 95) press.pos += 5; }
  function cashOut(){
    clearInterval(press.l);
    const win = Math.floor(press.bet * press.mul);
    s.gold += win; save(); notify(`Won ${win}G`); resetPress();
  }
  function resetPress(){ $('pressure-lobby').classList.remove('hidden'); $('pressure-game').classList.add('hidden'); }

  // COLLECTION
  function renderCol(){
    const g = $('col-grid'); g.innerHTML = '';
    s.col.forEach(c => {
      const t = s.pool.find(x=>x.id===c.tid); const r = s.rarity.find(x=>x.id===c.rid);
      const d = document.createElement('div'); d.className='card-thumb';
      d.innerHTML = `<img src="${t.img}"><div class="rarity-tag" style="background:${r.c}"></div>`;
      d.onclick = () => showSheet(c);
      g.appendChild(d);
    });
  }
  function showSheet(c){
    curC = c; const t = s.pool.find(x=>x.id===c.tid); const r = s.rarity.find(x=>x.id===c.rid);
    $('sheet-name').innerText = t.name; $('sheet-img').innerHTML=`<img src="${t.img}" style="width:100%;height:100%;object-fit:cover;">`;
    $('sheet-stats').innerHTML = Object.keys(c.stat).map(k=>`<span style="background:#333;padding:4px 8px;border-radius:4px;font-size:12px;">${k}:${c.stat[k]}</span>`).join('');
    $('sheet-modal').classList.add('active');
    const btn = $('btn-deck-tog');
    if(curD) {
      const d = s.decks.find(x=>x.id===curD);
      btn.innerText = d.cards.includes(c.id) ? "Remove" : "Add";
      btn.className = d.cards.includes(c.id) ? "btn danger" : "btn filled";
    } else { btn.style.display='none'; }
  }
  function closeSheet(){ $('sheet-modal').classList.remove('active'); }
  function delCard(){ s.col = s.col.filter(x=>x.id!==curC.id); save(); renderCol(); closeSheet(); }
  function togDeck(){ 
    const d = s.decks.find(x=>x.id===curD);
    if(d.cards.includes(curC.id)) d.cards = d.cards.filter(x=>x!==curC.id); else d.cards.push(curC.id);
    save(); showSheet(curC);
  }

  // LAB & SETTINGS
  function initLab(){
    const sl = $('deck-sel'); sl.innerHTML='<option value="">None</option>';
    s.decks.forEach(d=>sl.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
    const fa=$('fuse-a'), fb=$('fuse-b'); fa.innerHTML='<option>A</option>'; fb.innerHTML='<option>B</option>';
    s.col.forEach(c=>{ const o=`<option value="${c.id}">${s.pool.find(x=>x.id===c.tid).name}</option>`; fa.innerHTML+=o; fb.innerHTML+=o; });
  }
  function saveDeck(){ const n=$('deck-name').value; if(n){ s.decks.push({id:uid(),name:n,cards:[]}); save(); initLab(); } }
  function selDeck(v){ curD = v; $('btn-deck-tog').style.display = v?'block':'none'; }
  function fuse(){
    const a=$('fuse-a').value, b=$('fuse-b').value;
    if(!a||!b||a===b) return notify("Invalid Fuse");
    const ca=s.col.find(x=>x.id===a), cb=s.col.find(x=>x.id===b);
    const newC = createCard(Math.random()>.5?ca.tid:cb.tid, ca.rid);
    s.col = s.col.filter(x=>x.id!==a && x.id!==b); s.col.push(newC);
    save(); initLab(); notify("Fused!");
  }
  function initSet(){ 
    $('wall-in').value = s.wall; $('pool-in').value = s.pool.map(p=>`[${p.name}]${p.img}`).join('\n');
    $('stat-list').innerHTML = s.stats.map(k=>`<div class="list-row"><label>${k}</label><div class="btn danger sm" onclick="app.remStat('${k}')">X</div></div>`).join('');
  }
  function setWall(){ s.wall=$('wall-in').value; save(); init(); }
  function parsePool(){ 
    const p=[]; $('pool-in').value.split('\n').forEach(l=>{const m=l.match(/\[(.*?)\](.*)/); if(m) p.push({id:uid(),name:m[1],img:m[2]})});
    if(p.length){ s.pool=p; save(); notify("Pool Updated"); }
  }
  function loadDemo(){ $('pool-in').value=`[Dragon]https://img.icons8.com/color/96/dragon.png\n[Knight]https://img.icons8.com/color/96/knight.png\n[Wizard]https://img.icons8.com/color/96/wizard.png`; parsePool(); }
  function wipe(){ localStorage.clear(); location.reload(); }
  function addStat(){ const v=$('stat-in').value; if(v){ s.stats.push(v); save(); initSet(); } }
  function remStat(k){ s.stats=s.stats.filter(x=>x!==k); save(); initSet(); }

  // DICE & ROYALE
  function pickDice(){ if(s.col.length){ dice.c=rand(s.col); $('dice-btn').disabled=false; notify("Selected"); } else notify("No Cards"); }
  function rollDice(){ 
     if(!dice.c) return; 
     const st=rand(s.stats); const r1=Math.ceil(Math.random()*6); const r2=Math.ceil(Math.random()*6);
     $('dice-p').innerText=r1; $('dice-ai').innerText=r2;
     if(dice.c.stat[st]+r1 > r2+20) { dice.s++; s.gold+=20; notify("Won 20G"); } else { dice.s=0; notify("Lost"); }
     $('dice-res').innerText=`Streak: ${dice.s}`; save();
  }
  function runRoyale(){
    let p=s.col; if($('royale-src').value==='deck' && curD) p=s.col.filter(c=>s.decks.find(d=>d.id===curD).cards.includes(c.id));
    if(p.length<2) return notify("Need 2+ Cards");
    let l=''; p=[...p].sort(()=>Math.random()-.5);
    while(p.length>1){ const a=p.pop(),b=p.pop(),st=rand(s.stats); const w=a.stat[st]>b.stat[st]?a:b; p.unshift(w); l+=`${s.pool.find(x=>x.id===w.tid).name} won (${st})<br>`; }
    $('royale-log').innerHTML=l; notify("Sim Complete. +100G"); s.gold+=100; save();
  }
  function initMem(){ if(s.pool.length<2) return; mem.g=[]; const g=$('mem-grid'); g.innerHTML=''; const set=[]; for(let i=0;i<6;i++) set.push(rand(s.pool)); [...set,...set].sort(()=>Math.random()-.5).forEach((t,i)=>{const d=document.createElement('div');d.className='card-thumb';d.onclick=()=>{if(d.innerHTML)return;d.innerHTML=`<img src="${t.img}">`;if(!mem.f)mem.f={d,t};else{if(mem.f.t.id===t.id){mem.f=null;if(++mem.c===6){notify("Win 50G");s.gold+=50;save();}}else{setTimeout(()=>{d.innerHTML='';mem.f.d.innerHTML='';mem.f=null;},500)}}};g.appendChild(d);}); }

  window.onload = init;
  return { open, home, buyPack, closePack, initDuel, filterDuel, resolveDuel, startPressure, pressureTap, cashOut, showSheet, closeSheet, delCard, togDeck, saveDeck, selDeck, fuse, setWall, parsePool, loadDemo, wipe, addStat, remStat, pickDice, rollDice, runRoyale, initMem };
})();
</script>
</body>
</html>



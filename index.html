<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>deckforge</title>
<style>
:root{
  --bg-grad: radial-gradient(circle at 50% 0%, #1e1b4b, #0f172a 60%, #020617);
  
  /* "Liquid Glass" for Main Windows - Untinted, Low Blur */
  --liquid-bg: rgba(255, 255, 255, 0.02);
  --liquid-blur: blur(4px);
  --liquid-border: rgba(255, 255, 255, 0.1);
  --liquid-highlight: rgba(255, 255, 255, 0.15);
  --liquid-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.2);

  /* "Deep Cherry Glass" for Bars - Vibrant, No Brown */
  --bar-bg: rgba(110, 10, 50, 0.65); 
  --bar-border: rgba(255, 105, 180, 0.3); /* Hot pink highlight */
  --bar-blur: blur(12px);
  
  --text-main: #f8fafc;
  --text-muted: #cbd5e1;
  --accent: #e2e8f0;
  
  --radius-lg: 24px;
  --radius-md: 16px;
  --radius-sm: 12px;
}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{
  margin:0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: var(--bg-grad);
  background-attachment: fixed;
  color: var(--text-main);
  display: flex;
  flex-direction: column;
}
#wallpaper-layer{
  position:fixed; inset:0; z-index:-2;
  background-size:cover; background-position:center;
  opacity: 0.8;
}

/* HEADER */
header{
  position:sticky; top:0; z-index:50;
  padding:12px 16px;
  background: var(--bar-bg);
  border-bottom: 1px solid var(--bar-border);
  backdrop-filter: var(--bar-blur);
  -webkit-backdrop-filter: var(--bar-blur);
  display:flex; justify-content:space-between; align-items:center;
  box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
h1{
  margin:0; font-size:16px; font-weight: 800; letter-spacing:.05em; text-transform:uppercase;
  color: #fff; 
  text-shadow: 0 0 10px rgba(255, 20, 100, 0.5);
}
.stat-bar{ display:flex; gap:10px; font-size:11px; font-weight:600; color:var(--text-muted); }
.stat-bar strong{ color:#fff; margin-left:3px; }

main{ flex:1; padding:16px 16px 100px; max-width:800px; width:100%; margin:0 auto; }
.view{display:none; animation: fadeIn 0.3s ease;}
.view.active{display:block;}
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* PANELS (Liquid Style) */
.panel{
  margin-bottom:16px; border-radius:var(--radius-lg); padding:16px;
  background: var(--liquid-bg);
  border: 1px solid var(--liquid-border);
  border-top: 1px solid var(--liquid-highlight);
  box-shadow: var(--liquid-shadow);
  backdrop-filter: var(--liquid-blur);
  -webkit-backdrop-filter: var(--liquid-blur);
}
.panel-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.panel-title{ margin:0; font-size:13px; letter-spacing:.08em; font-weight: 700; text-transform:uppercase; color: #fff; text-shadow:0 2px 4px rgba(0,0,0,0.5); }

/* UI Elements */
.btn{
  appearance:none; border:none; border-radius:99px; padding:10px 16px;
  font-size:11px; font-weight:700; letter-spacing:.05em; text-transform:uppercase;
  cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:6px;
  background: linear-gradient(135deg, #f8fafc, #cbd5e1); color: #0f172a;
  box-shadow: 0 4px 12px rgba(255,255,255,0.15); transition:all 0.1s;
}
.btn:active{ transform:scale(0.96); }
.btn.ghost{ background:transparent; color:var(--accent); border:1px solid var(--liquid-border); box-shadow:none; }
.btn.ghost:hover{ background:rgba(255,255,255,0.1); }
.btn.soft{ background:rgba(255,255,255,0.1); color:var(--accent); border:1px solid var(--liquid-border); box-shadow:none; }
.btn.soft:hover{ background:rgba(255,255,255,0.2); }
.btn.warn{ background:linear-gradient(135deg, #f87171, #dc2626); color:#fff; }
.btn.ok{ background:linear-gradient(135deg, #4ade80, #16a34a); color:#022c22; }
.btn.sm{ padding:6px 12px; font-size:10px; }
.btn.full{ width:100%; }
.btn:disabled{ opacity:0.5; pointer-events:none; filter:grayscale(1); }

.field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
label{ font-size:10px; letter-spacing:.08em; text-transform:uppercase; color:var(--text-muted); font-weight: 600; text-shadow:0 1px 2px rgba(0,0,0,0.8); }
input, select, textarea{
  width:100%; border-radius:12px; padding:10px 12px;
  border:1px solid var(--liquid-border); background: rgba(0,0,0,0.3); color:#fff;
  font-size:13px; outline:none; font-family:inherit;
  backdrop-filter: blur(4px);
}
.row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.row.space{ justify-content:space-between; }
.stack{ display:flex; flex-direction:column; gap:8px; }
.small{ font-size:11px; color:var(--text-muted); }
hr{ border:0; height:1px; background:rgba(255,255,255,0.15); margin:12px 0; }

/* Mode Grid */
.mode-grid{ display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; }
.mode-tile{
  aspect-ratio:1; background:rgba(255,255,255,0.05); border:1px solid var(--liquid-border);
  border-radius:var(--radius-md); display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:8px; cursor:pointer; color:var(--text-muted);
  transition:all 0.2s;
}
.mode-tile:hover{ background:rgba(255,255,255,0.15); color:#fff; transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.2); }
.mode-tile svg{ width:24px; height:24px; stroke-width:1.5; }
.mode-tile span{ font-size:10px; font-weight:700; text-transform:uppercase; }

/* Games */
.duel-layout{ background:rgba(0,0,0,0.2); border-radius:var(--radius-md); padding:12px; border:1px solid var(--liquid-border); }
.duel-board{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:10px 0; }
.duel-slot{ min-height:120px; border:1px solid var(--liquid-border); border-radius:var(--radius-sm); background:rgba(0,0,0,0.3); display:flex; flex-direction:column; align-items:center; justify-content:center; position:relative; }
.round-dots{ display:flex; gap:4px; }
.round-dot{ width:6px; height:6px; border-radius:9px; background:rgba(255,255,255,0.2); }
.round-dot.win{ background:#4ade80; box-shadow:0 0 6px #4ade80; }
.round-dot.loss{ background:#f87171; }

.dice-stage{ display:flex; justify-content:space-between; align-items:center; padding:20px 10px; background:rgba(0,0,0,0.3); border-radius:var(--radius-md); margin-bottom:10px; }
.dice-box{ width:50px; height:50px; background:#fff; border-radius:10px; color:#000; display:flex; align-items:center; justify-content:center; font-size:20px; font-weight:800; }
.dice-label{ font-size:10px; text-transform:uppercase; color:var(--text-muted); text-align:center; margin-bottom:4px; }

.pressure-track{ height:40px; background:rgba(0,0,0,0.5); border-radius:15px; border:1px solid var(--liquid-border); position:relative; overflow:hidden; margin:20px 0; }
.pressure-zone{ position:absolute; inset:0; background:linear-gradient(90deg, rgba(248,113,113,0.5) 0%, rgba(74,222,128,0.1) 20%, rgba(74,222,128,0.1) 80%, rgba(248,113,113,0.5) 100%); }
.pressure-bar{ position:absolute; width:8px; height:28px; top:6px; background:#fff; border-radius:4px; box-shadow:0 0 12px #fff; transition:left 0.05s linear; z-index:2; }

.memory-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:12px; }
.mem-card{ aspect-ratio:3/4; position:relative; perspective:1000px; cursor:pointer; }
.mem-inner{ position:relative; width:100%; height:100%; transition:transform 0.4s; transform-style:preserve-3d; }
.mem-card.flip .mem-inner{ transform:rotateY(180deg); }
.mem-front, .mem-back{ position:absolute; inset:0; backface-visibility:hidden; border-radius:8px; border:1px solid var(--liquid-border); display:flex; align-items:center; justify-content:center; }
.mem-front{ background:rgba(255,255,255,0.1); color:rgba(255,255,255,0.2); font-size:20px; }
.mem-back{ background:#0f172a; transform:rotateY(180deg); }
.mem-back img{ width:100%; height:100%; object-fit:cover; border-radius:8px; }

/* Cards */
.card-grid{ display:grid; grid-template-columns:repeat(2, 1fr); gap:10px; }
@media(min-width:600px){ .card-grid{ grid-template-columns:repeat(4, 1fr); } }
.card-tile{ border-radius:var(--radius-sm); background:rgba(255,255,255,0.05); border:1px solid var(--liquid-border); overflow:hidden; position:relative; transition:transform 0.2s; cursor:pointer; box-shadow:0 4px 6px rgba(0,0,0,0.1); }
.card-tile:hover{ transform:translateY(-3px); background:rgba(255,255,255,0.15); border-color:rgba(255,255,255,0.4); }
.card-img-wrap{ width:100%; aspect-ratio:2/3; background:rgba(0,0,0,0.4); overflow:hidden; display:flex; align-items:center; justify-content:center; }
.card-img-wrap img{ width:100%; height:100%; object-fit:cover; }
.card-body{ padding:8px; }
.card-name{ font-size:11px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:#fff; }
.card-stat-row{ display:flex; gap:4px; margin-top:4px; flex-wrap:wrap; }
.stat-pill{ padding:2px 6px; background:rgba(255,255,255,0.1); border-radius:4px; font-size:9px; color:var(--text-muted); border:1px solid rgba(255,255,255,0.1); }
.rarity-badge{ position:absolute; top:4px; left:4px; padding:2px 6px; border-radius:8px; font-size:9px; font-weight:700; background:rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.2); color:#fff; z-index:2; }

/* NAVBAR */
.navbar{ 
  position:fixed; bottom:0; left:0; right:0; 
  padding:8px 12px 20px; 
  display:flex; justify-content:space-around; z-index:40;
  background: var(--bar-bg);
  border-top: 1px solid var(--bar-border);
  backdrop-filter: var(--bar-blur);
  -webkit-backdrop-filter: var(--bar-blur);
  box-shadow: 0 -4px 20px rgba(0,0,0,0.2);
}
.nav-btn{ flex:1; max-width:70px; background:transparent; border:none; color:var(--text-muted); display:flex; flex-direction:column; align-items:center; gap:4px; font-size:9px; cursor:pointer; padding:6px; border-radius:8px; transition:all 0.2s; }
.nav-btn svg{ width:20px; height:20px; stroke-width:2; }
.nav-btn.active{ color:#fff; background:rgba(255,255,255,0.15); box-shadow:0 0 10px rgba(255,255,255,0.1); }

/* Overlays */
.pack-overlay{ position:fixed; inset:0; z-index:100; background:rgba(0,0,0,0.9); display:none; flex-direction:column; align-items:center; justify-content:center; padding:20px; backdrop-filter:blur(8px); }
.pack-overlay.active{ display:flex; animation:fadeIn 0.2s; }
.pack-box{ width:160px; height:220px; background:linear-gradient(135deg, #f59e0b, #b45309); border:2px solid #fff; border-radius:12px; box-shadow:0 0 30px #f59e0b; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:transform 0.2s; }
.pack-box:hover{ transform:scale(1.05); }
.pack-box.shake{ animation:shake 0.5s ease-in-out; }
.pack-box.open{ animation:poof 0.4s forwards; pointer-events:none; }
.pack-reveal{ display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; width:100%; max-width:400px; }
.revealed-card{ opacity:0; transform:scale(0.5); animation:revealPop 0.5s forwards; }

@keyframes shake{ 0%,100%{transform:rotate(0);} 25%{transform:rotate(5deg);} 75%{transform:rotate(-5deg);} }
@keyframes poof{ to{opacity:0; transform:scale(1.5);} }
@keyframes revealPop{ to{opacity:1; transform:scale(1);} }

.sheet-layer{ position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:90; display:none; align-items:flex-end; backdrop-filter:blur(4px); }
.sheet-layer.active{ display:flex; }
.sheet{ width:100%; background:#0f172a; border-top:1px solid var(--glass-border); border-radius:24px 24px 0 0; padding:20px; max-height:85vh; overflow-y:auto; animation:slideUp 0.3s; }
@keyframes slideUp{ from{transform:translateY(100%);} to{transform:translateY(0);} }

.toast{ position:fixed; bottom:90px; left:50%; transform:translateX(-50%) translateY(20px); background:#fff; color:#000; padding:8px 16px; border-radius:20px; font-size:12px; font-weight:600; opacity:0; pointer-events:none; transition:all 0.3s; z-index:200; box-shadow:0 4px 20px rgba(0,0,0,0.5); }
.toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
.hidden{ display:none!important; }
</style>
</head>
<body>
<div id="wallpaper-layer"></div>

<header>
  <h1>DECKFORGE</h1>
  <div class="stat-bar">
    <span id="meta-lvl">LVL <strong>1</strong></span>
    <span id="meta-elo">ELO <strong>100</strong></span>
    <span id="meta-cards">CARDS <strong>0</strong></span>
  </div>
</header>

<main>
  <!-- PLAY HOME -->
  <section id="view-play" class="view active">
    <div class="panel">
      <div class="panel-header"><h2 class="panel-title">Play Modes</h2></div>
      <div class="mode-grid">
        <div class="mode-tile" onclick="app.openMode('duel')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="M13 19l6-6"/><path d="M16 16l4 4"/><path d="M19 21l2-2"/></svg>
          <span>Duel</span>
        </div>
        <div class="mode-tile" onclick="app.openMode('battle')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3 6 6 1-4.5 4.5 1.5 6-6-3-6 3 1.5-6L2 9l6-1 3-6z"/></svg>
          <span>Royale</span>
        </div>
        <div class="mode-tile" onclick="app.openMode('memory')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
          <span>Memory</span>
        </div>
        <div class="mode-tile" onclick="app.openMode('dice')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/></svg>
          <span>Dice</span>
        </div>
        <div class="mode-tile" onclick="app.openMode('pressure')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v20M2 12h20"/><circle cx="12" cy="12" r="10"/></svg>
          <span>Pressure</span>
        </div>
      </div>
    </div>

    <!-- DUEL -->
    <div id="panel-duel" class="panel hidden">
      <div class="panel-header">
        <h2 class="panel-title">Duel</h2>
        <button class="btn sm ghost close-panel" onclick="app.closePanels()">Back</button>
      </div>
      <div class="duel-layout">
        <div class="row space" style="margin-bottom:8px;">
          <span class="small" id="duel-round">Round 1</span>
          <div class="round-dots" id="duel-dots"></div>
        </div>
        <div class="duel-board">
          <div class="duel-slot" id="slot-you"><span class="small">SELECT CARD</span></div>
          <div class="duel-slot" id="slot-ai"><span class="small">OPPONENT</span></div>
        </div>
        <div style="text-align:center; margin:8px 0; font-weight:700;" id="duel-msg"></div>
        <div class="row space">
          <div class="row">
            <span class="small">You: <strong id="score-you">0</strong></span>
            <span class="small">AI: <strong id="score-ai">0</strong></span>
          </div>
          <div class="row">
            <button class="btn sm ghost" onclick="app.newDuel()">New</button>
            <button class="btn sm" id="btn-duel-fight" onclick="app.resolveDuelRound()" disabled>Fight</button>
          </div>
        </div>
        <div id="duel-strip" style="margin-top:12px; display:flex; overflow-x:auto; gap:8px; padding-bottom:8px;"></div>
      </div>
    </div>

    <!-- BATTLE -->
    <div id="panel-battle" class="panel hidden">
      <div class="panel-header">
        <h2 class="panel-title">Auto Royale</h2>
        <button class="btn sm ghost close-panel" onclick="app.closePanels()">Back</button>
      </div>
      <div class="field">
        <label>Source</label>
        <select id="battle-source">
          <option value="all">All Cards</option>
          <option value="deck">Current Deck</option>
        </select>
      </div>
      <button class="btn full" onclick="app.runBattle()">Simulate Royale</button>
      <div class="log-box" id="battle-log" style="margin-top:12px; max-height:150px; overflow-y:auto; font-family:monospace; font-size:11px; background:rgba(0,0,0,0.3); padding:8px; border-radius:8px;"></div>
    </div>

    <!-- MEMORY -->
    <div id="panel-memory" class="panel hidden">
      <div class="panel-header">
        <h2 class="panel-title">Memory Match</h2>
        <button class="btn sm ghost close-panel" onclick="app.closePanels()">Back</button>
      </div>
      <div class="memory-grid" id="memory-grid"></div>
      <button class="btn full" onclick="app.initMemory()">New Game</button>
    </div>

    <!-- DICE -->
    <div id="panel-dice" class="panel hidden">
      <div class="panel-header">
        <h2 class="panel-title">Risky Dice</h2>
        <button class="btn sm ghost close-panel" onclick="app.closePanels()">Back</button>
      </div>
      <div class="dice-stage">
        <div class="stack" style="align-items:center; flex:1;">
          <div class="dice-label">You</div>
          <div class="dice-box" id="dice-you">?</div>
          <div class="dice-label">Base: <span id="dice-base-you">0</span></div>
        </div>
        <div style="font-weight:800; color:var(--text-muted);">VS</div>
        <div class="stack" style="align-items:center; flex:1;">
          <div class="dice-label">AI</div>
          <div class="dice-box" id="dice-ai">?</div>
          <div class="dice-label">Base: <span id="dice-base-ai">0</span></div>
        </div>
      </div>
      <div class="row space">
        <div class="stack" style="gap:2px;">
          <span class="small" id="dice-card-name">No Card Selected</span>
          <span class="small" style="color:#eab308;" id="dice-streak">Streak: 0</span>
        </div>
        <div class="row">
          <button class="btn sm soft" onclick="app.pickDiceCard()">Pick</button>
          <button class="btn sm" id="btn-dice-roll" onclick="app.rollDice()" disabled>Roll</button>
        </div>
      </div>
    </div>

    <!-- PRESSURE -->
    <div id="panel-pressure" class="panel hidden">
      <div class="panel-header">
        <h2 class="panel-title">Pressure Survival</h2>
        <button class="btn sm ghost close-panel" onclick="app.closePanels()">Back</button>
      </div>
      <div class="card-tile" id="pressure-card-view" style="display:none; margin-bottom:12px;">
        <!-- Card preview injected here -->
      </div>
      <div class="small" id="pressure-dialogue" style="text-align:center; font-style:italic; min-height:16px; margin-bottom:12px; color:#e2e8f0; font-weight:600;"></div>
      
      <div class="pressure-track">
        <div class="pressure-zone" id="p-zone"></div>
        <div class="pressure-bar" id="p-bar" style="left:50%;"></div>
      </div>
      <div class="row space" style="margin-bottom:12px;">
        <span class="small" id="p-lvl">Level 1</span>
        <span class="small" id="p-time">0s / 30s</span>
      </div>
      <button class="btn full" style="height:60px; font-size:14px;" onmousedown="app.pressureTap()" ontouchstart="app.pressureTap()">TAP TO SURVIVE</button>
      <button class="btn sm soft full" style="margin-top:12px;" onclick="app.startPressure()">Start Run</button>
    </div>
  </section>

  <!-- COLLECTION -->
  <section id="view-collection" class="view">
    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Collection</h2>
        <button class="btn sm soft" id="btn-starter-pack" onclick="app.openStarterBox()">Add Pack</button>
      </div>
      <div class="card-grid" id="collection-grid"></div>
      <div id="col-empty" class="small" style="text-align:center; padding:20px;">No cards. Open a pack!</div>
    </div>
  </section>

  <!-- LAB -->
  <section id="view-lab" class="view">
    <div class="panel">
      <div class="panel-header"><h2 class="panel-title">Laboratory</h2></div>
      
      <div class="field">
        <label>Deck Management</label>
        <div class="row">
          <input type="text" id="deck-input" placeholder="New Deck Name">
          <button class="btn sm" onclick="app.saveDeck()">Save</button>
        </div>
        <select id="deck-select"></select>
      </div>
      <hr>
      <div class="field">
        <label>Fusion</label>
        <div class="row space">
          <button class="btn sm soft" onclick="app.setFusion('a')">Set Card A</button>
          <button class="btn sm soft" onclick="app.setFusion('b')">Set Card B</button>
        </div>
        <div class="small" id="fuse-status" style="text-align:center; margin:6px 0;">Select cards from collection</div>
        <button class="btn full" onclick="app.runFusion()">Fuse Cards</button>
      </div>
      <hr>
      <div class="field">
        <label>Dialogue Editor</label>
        <select id="dialog-card-select" onchange="app.loadDialog(this.value)"></select>
        <input type="text" id="inp-summon" placeholder="On Summon..." style="margin-top:6px;">
        <input type="text" id="inp-win" placeholder="On Win..." style="margin-top:6px;">
        <input type="text" id="inp-lose" placeholder="On Lose..." style="margin-top:6px;">
        <button class="btn sm full" style="margin-top:6px;" onclick="app.saveDialogue()">Save Lines</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="view-settings" class="view">
    <div class="panel">
      <div class="panel-header"><h2 class="panel-title">Settings</h2></div>
      <div class="stack">
        <div class="field">
          <label>Stats Config</label>
          <div class="row">
            <input type="text" id="stat-input" placeholder="e.g. Magic">
            <button class="btn sm" onclick="app.addStat()">Add</button>
            <button class="btn sm ghost" onclick="app.resetStats()">Reset</button>
          </div>
          <div class="row" id="stat-chips" style="margin-top:4px;"></div>
        </div>
        <hr>
        <div class="field">
          <label>Duel Rules</label>
          <div class="row space">
            <span class="small">Rounds</span>
            <input type="number" id="inp-rounds" style="width:60px;" min="1" max="9" onchange="app.updateRule('rounds', this.value)">
          </div>
          <div class="row space">
            <span class="small">RNG %</span>
            <input type="number" id="inp-rng" style="width:60px;" min="0" max="50" onchange="app.updateRule('rng', this.value)">
          </div>
        </div>
        <hr>
        <div class="field">
          <label>Rarity Multipliers</label>
          <div id="rarity-list" class="stack"></div>
        </div>
        <hr>
        <div class="field">
          <label>Wallpaper</label>
          <div class="row">
            <input type="text" id="wall-input" placeholder="Image URL">
            <button class="btn sm" onclick="app.setWallpaper()">Set</button>
          </div>
        </div>
        <div class="field">
          <label>Pool Data</label>
          <textarea id="pool-area" style="height:80px;" placeholder="[Name]URL..."></textarea>
          <div class="row">
            <button class="btn sm" onclick="app.parsePool()">Parse</button>
            <button class="btn sm ghost" onclick="app.loadDemoPool()">Demo</button>
          </div>
        </div>
        <div class="row space">
          <button class="btn sm warn" onclick="app.hardReset()">Wipe Data</button>
          <button class="btn sm soft" onclick="app.exportSave()">Export</button>
        </div>
        <hr>
        <button class="btn full soft" onclick="app.toggleFullscreen()">Toggle Fullscreen</button>
      </div>
    </div>
  </section>
</main>

<nav class="navbar">
  <button class="nav-btn active" onclick="app.setView('play')" id="nav-play">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h4l3-3 4 6 3-3h4"/><circle cx="8" cy="20" r="2"/><circle cx="16" cy="20" r="2"/></svg>
    <span>Play</span>
  </button>
  <button class="nav-btn" onclick="app.setView('collection')" id="nav-collection">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="7" height="7"/><rect x="14" y="4" width="7" height="7"/><rect x="3" y="15" width="7" height="7"/><rect x="14" y="15" width="7" height="7"/></svg>
    <span>Cards</span>
  </button>
  <button class="nav-btn" onclick="app.setView('lab')" id="nav-lab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h4l2 13a3 3 0 1 0 6 0l2-13h4"/></svg>
    <span>Lab</span>
  </button>
  <button class="nav-btn" onclick="app.setView('settings')" id="nav-settings">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    <span>Config</span>
  </button>
</nav>

<!-- OVERLAYS -->
<div class="pack-overlay" id="pack-overlay">
  <div class="pack-box" id="pack-box">
    <div style="color:#fff; font-weight:800; font-size:24px; text-shadow:0 2px 4px rgba(0,0,0,0.5);">OPEN</div>
  </div>
  <div class="pack-reveal" id="pack-reveal"></div>
  <button class="btn sm soft" id="pack-close" onclick="app.closePack()" style="margin-top:20px; display:none;">Close</button>
</div>

<div class="sheet-layer" id="sheet-layer">
  <div class="sheet">
    <div class="panel-header">
      <h2 class="panel-title" id="sheet-name">Card</h2>
      <button class="btn sm ghost" onclick="app.closeSheet()">X</button>
    </div>
    <div class="row" style="align-items:flex-start; gap:12px;">
      <div class="card-img-wrap" id="sheet-img" style="width:40%; border-radius:8px;"></div>
      <div class="stack" style="flex:1;">
        <div class="row">
          <span class="rarity-badge" id="sheet-rarity" style="position:static;">Rarity</span>
        </div>
        <div class="card-stat-row" id="sheet-stats"></div>
        <div class="small" id="sheet-meta"></div>
        <hr>
        <button class="btn sm soft full" onclick="app.toggleSheetDeck()">Toggle Deck</button>
        <button class="btn sm warn full" onclick="app.deleteSheetCard()">Delete</button>
      </div>
    </div>
    <div class="stack" style="margin-top:16px;">
      <div class="small" style="font-weight:700;">Dialogue</div>
      <ul style="margin:0; padding-left:16px; color:var(--text-muted); font-size:12px;" id="sheet-dialogue"></ul>
    </div>
  </div>
</div>

<div class="toast" id="toast">Message</div>

<script>
const app = (function(){
  const DEFAULT_SAVE = {
    version: 13,
    pool: [], collection: [], decks: [], dialogues: {},
    stats: ['ATK','DEF','SPD'],
    rarities: [
      {id:'c', name:'Common', color:'#94a3b8', roll:[20,60], factor:1.0},
      {id:'u', name:'Uncommon', color:'#22c55e', roll:[50,100], factor:1.2},
      {id:'r', name:'Rare', color:'#3b82f6', roll:[90,150], factor:1.5},
      {id:'e', name:'Epic', color:'#a855f7', roll:[140,220], factor:2.0},
      {id:'l', name:'Legendary', color:'#eab308', roll:[210,350], factor:3.0}
    ],
    settings: { rounds:5, rng:20, aiScale:1.1 },
    profile: {level:1, elo:100},
    wallpaper: '',
    starterClaimed: false
  };

  let save = JSON.parse(JSON.stringify(DEFAULT_SAVE));
  let duel = {round:1, pScore:0, aiScore:0, history:[], active:false, usedIds:[]};
  let selDuelCard = null;
  let fusion = {a:null, b:null};
  let curSheetId = null;
  let dice = {card:null, streak:0};
  let pressure = {active:false, loop:null, level:1, timer:0, pos:50, riskCard:null, visualCard:null};
  let memory = {grid:[], first:null, lock:false};

  const $ = id => document.getElementById(id);
  const uid = () => Math.random().toString(36).slice(2);
  const rand = arr => arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
  const toast = msg => { const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); };
  const persist = () => { localStorage.setItem('df_v13', JSON.stringify(save)); updateMeta(); };
  
  function init(){
    try {
      const raw = localStorage.getItem('df_v13');
      if(raw) {
        const l = JSON.parse(raw);
        if(l.version >= 13) save = l;
      }
    } catch(e) { console.log("Resetting corrupt save"); }
    
    if(save.wallpaper) $('wallpaper-layer').style.backgroundImage = `url('${save.wallpaper}')`;
    if(!save.pool) save.pool = []; 
    
    updateStarterButton();
    renderAll();
  }

  function updateMeta(){
    $('meta-lvl').innerHTML = `LVL <strong>${save.profile.level}</strong>`;
    $('meta-elo').innerHTML = `ELO <strong>${save.profile.elo}</strong>`;
    $('meta-cards').innerHTML = `CARDS <strong>${save.collection.length}</strong>`;
  }
  function updateStarterButton(){
    const btn = $('btn-starter-pack');
    if(save.starterClaimed) {
      btn.disabled = true;
      btn.textContent = "Claimed";
      btn.style.opacity = 0.5;
    }
  }

  function createCard(t, specificRarityId){
    const r = Math.random();
    const rid = specificRarityId ? specificRarityId : (r<0.6?'c':r<0.85?'u':r<0.95?'r':r<0.99?'e':'l');
    const rarity = save.rarities.find(x=>x.id===rid) || save.rarities[0];
    const stats = {};
    save.stats.forEach(s => {
      const base = Math.floor(rarity.roll[0] + Math.random()*(rarity.roll[1]-rarity.roll[0]));
      stats[s] = Math.floor(base * (rarity.factor || 1));
    });
    return {id:uid(), tid:t.id, rid, stats};
  }
  function getTemplate(c){ return save.pool.find(p=>p.id===c.tid) || {name:'Unknown', imageUrl:''}; }
  function getRarity(c){ return save.rarities.find(r=>r.id===c.rid) || save.rarities[0]; }

  // --- MODES ---
  function setView(v){
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active'));
    $(`view-${v}`).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active'));
    $(`nav-${v}`).classList.add('active');
    if(v==='lab') renderDialogSelect(); 
  }
  function openMode(mode){
    document.querySelectorAll('.panel[id^="panel-"]').forEach(p => p.classList.add('hidden'));
    const p = $(`panel-${mode}`);
    if(p) p.classList.remove('hidden');
    if(mode === 'pressure') initPressure();
    if(mode === 'dice') initDice();
    if(mode === 'memory') initMemory();
    if(mode === 'duel') newDuel();
  }
  function closePanels(){
    document.querySelectorAll('.panel[id^="panel-"]').forEach(p => p.classList.add('hidden'));
    if(pressure.loop) clearInterval(pressure.loop);
  }

  // --- PACKS ---
  function openStarterBox(){
    if(save.starterClaimed) return;
    if(!save.pool.length) return toast("No pool data!");
    
    save.starterClaimed = true;
    const cards = [];
    for(let i=0; i<4; i++) cards.push(createCard(rand(save.pool)));
    save.collection.push(...cards);
    persist();
    renderCollection();
    updateStarterButton();
    
    const ov = $('pack-overlay');
    ov.classList.add('active');
    $('pack-box').style.display = 'flex';
    $('pack-box').classList.remove('open');
    $('pack-reveal').innerHTML = '';
    $('pack-close').style.display = 'none';
    
    $('pack-box').onclick = function(){
      this.classList.add('shake');
      setTimeout(()=>{
        this.classList.add('open');
        setTimeout(()=>{
          this.style.display='none';
          cards.forEach((c,i)=>{
            const t = getTemplate(c);
            const r = getRarity(c);
            const d = document.createElement('div');
            d.className = 'card-tile revealed-card';
            d.style.animationDelay = (i*0.15)+'s';
            d.innerHTML = `<div class="card-img-wrap"><img src="${t.imageUrl}"></div><div class="card-body"><div class="card-name">${t.name}</div></div><div class="rarity-badge" style="color:${r.color}">${r.name}</div>`;
            $('pack-reveal').appendChild(d);
          });
          setTimeout(()=>$('pack-close').style.display='inline-block', 1000);
        }, 300);
      }, 500);
    };
  }
  function closePack(){ $('pack-overlay').classList.remove('active'); }

  // --- PRESSURE ---
  function initPressure(){
    $('pressure-card-view').style.display = 'none';
    $('p-lvl').textContent = 'Level 1';
    $('p-time').textContent = '0s / 30s';
    $('pressure-dialogue').textContent = "";
    if(pressure.loop) clearInterval(pressure.loop);
  }
  
  function updatePressureVisuals(){
    pressure.visualCard = rand(save.collection) || pressure.riskCard;
    const t = getTemplate(pressure.visualCard);
    const d = save.dialogues[pressure.visualCard.id] || {};
    
    const pv = $('pressure-card-view');
    pv.style.display = 'block';
    // Adjusted aspect ratio for display
    pv.innerHTML = `<div class="card-img-wrap" style="height:auto; aspect-ratio:2/3; max-height:60vh;"><img src="${t.imageUrl}"></div><div class="card-body"><div class="card-name" style="text-align:center;font-size:16px;">${t.name}</div></div>`;
    
    $('pressure-dialogue').textContent = d.summon ? `"${d.summon}"` : `"${t.name} appears!"`;
  }

  function startPressure(){
    if(!save.collection.length) return toast("No cards!");
    // REMOVED CONFIRMATION
    pressure.active = true;
    pressure.level = 1;
    pressure.timer = 0;
    pressure.pos = 50;
    pressure.riskCard = save.collection[0];
    
    updatePressureVisuals();
    
    if(pressure.loop) clearInterval(pressure.loop);
    pressure.loop = setInterval(pressureTick, 30);
  }
  
  function pressureTick(){
    pressure.timer += 0.03;
    
    const force = 0.2 * Math.pow(1.2, pressure.level - 1);
    pressure.pos -= force;
    
    if(pressure.pos <= 0 || pressure.pos >= 100) {
      clearInterval(pressure.loop);
      save.collection = save.collection.filter(x=>x.id!==pressure.riskCard.id);
      persist(); renderCollection();
      toast("FAILED! Card Lost.");
      $('pressure-card-view').style.display='none';
      $('pressure-dialogue').textContent = "GAME OVER";
      return;
    }
    
    $('p-bar').style.left = pressure.pos + '%';
    $('p-time').textContent = Math.floor(pressure.timer) + 's / 30s';
    
    if(pressure.timer >= 30){
      pressure.timer = 0;
      pressure.pos = 50;
      
      if(save.pool.length){
        const roll = Math.random() * 100;
        let rid = 'c';
        const l = pressure.level;
        if(l===1 || l===2) rid='c';
        else if(l===3) rid = roll<75 ? 'c' : 'u';
        else if(l===4) rid = roll<55 ? 'c' : (roll<85 ? 'u' : 'r');
        else if(l===5) rid = roll<45 ? 'c' : (roll<78 ? 'u' : (roll<98 ? 'r' : 'e'));
        else if(l===6) rid = roll<30 ? 'c' : (roll<70 ? 'u' : (roll<95 ? 'r' : 'e'));
        else if(l===7) rid = roll<19 ? 'c' : (roll<49 ? 'u' : (roll<89 ? 'r' : (roll<99?'e':'l')));
        else if(l===8) rid = roll<17 ? 'c' : (roll<41 ? 'u' : (roll<73 ? 'r' : (roll<97?'e':'l')));
        else if(l===9) rid = roll<15 ? 'c' : (roll<33 ? 'u' : (roll<58 ? 'r' : (roll<88?'e':'l')));
        else if(l===10) rid = roll<5 ? 'c' : (roll<15 ? 'u' : (roll<35 ? 'r' : (roll<75?'e':'l')));
        else if(l>=11) rid = roll<1 ? 'c' : (roll<3 ? 'u' : (roll<15 ? 'r' : (roll<65?'e':'l')));

        const c = createCard(rand(save.pool), rid);
        save.collection.push(c); persist(); renderCollection();
        const rName = save.rarities.find(r=>r.id==rid).name;
        toast(`Level ${pressure.level} Done! +${rName} Card!`);
      }
      
      pressure.level++;
      $('p-lvl').textContent = `Level ${pressure.level}`;
      updatePressureVisuals();
    }
  }
  
  function pressureTap(){
    if(!pressure.active) return;
    pressure.pos += 3.5; 
  }

  // --- DICE ---
  function initDice(){
    dice = {card:null, streak:0};
    $('dice-you').textContent = '?';
    $('dice-ai').textContent = '?';
    $('dice-card-name').textContent = 'Select Card';
    $('btn-dice-roll').disabled = true;
  }
  function pickDiceCard(){
    if(!save.collection.length) return toast("No cards");
    dice.card = rand(save.collection);
    $('dice-card-name').textContent = getTemplate(dice.card).name;
    $('btn-dice-roll').disabled = false;
  }
  function rollDice(){
    if(!dice.card) return;
    const s = rand(save.stats);
    const pBase = dice.card.stats[s];
    const aiC = createCard(rand(save.pool));
    const aiBase = aiC.stats[s];
    const d1 = Math.ceil(Math.random()*6);
    const d2 = Math.ceil(Math.random()*6);
    
    $('dice-you').textContent = d1;
    $('dice-ai').textContent = d2;
    
    if((pBase+d1) > (aiBase+d2)){
      dice.streak++;
      $('dice-streak').textContent = `Streak: ${dice.streak}`;
      if(dice.streak>=3){
        toast("3-Streak! Card Won!");
        if(save.pool.length) { save.collection.push(createCard(rand(save.pool))); persist(); }
        dice.streak = 0;
      } else toast("Win! Keep going.");
    } else {
      dice.streak = 0;
      $('dice-streak').textContent = 'Streak: 0';
      toast("Lost.");
    }
  }

  // --- MEMORY ---
  function initMemory(){
    if(save.pool.length < 4) return toast("Need pool data");
    const g = $('memory-grid');
    g.innerHTML = '';
    memory = {grid:[], first:null, lock:false};
    const set = [];
    for(let i=0; i<8; i++) set.push(rand(save.pool));
    const cards = [...set, ...set].sort(()=>Math.random()-0.5);
    
    cards.forEach((t,i)=>{
      const d = document.createElement('div');
      d.className = 'mem-card';
      d.innerHTML = `<div class="mem-inner"><div class="mem-front">?</div><div class="mem-back"><img src="${t.imageUrl}"></div></div>`;
      d.onclick = () => flipMem(d, t, i);
      g.appendChild(d);
      memory.grid.push({el:d, t, matched:false});
    });
  }
  function flipMem(el, t, idx){
    if(memory.lock || el.classList.contains('flip') || memory.grid[idx].matched) return;
    el.classList.add('flip');
    if(!memory.first){
      memory.first = {el, t, idx};
    } else {
      memory.lock = true;
      if(memory.first.t.id === t.id){
        memory.grid[idx].matched = true;
        memory.grid[memory.first.idx].matched = true;
        memory.first = null;
        memory.lock = false;
        if(memory.grid.every(x=>x.matched)){
          toast("Cleared! Card Won!");
          if(save.pool.length) save.collection.push(createCard(rand(save.pool)));
          persist();
        }
      } else {
        setTimeout(()=>{
          el.classList.remove('flip');
          memory.first.el.classList.remove('flip');
          memory.first = null;
          memory.lock = false;
        }, 800);
      }
    }
  }

  // --- DUEL ---
  function newDuel(){
    if(save.collection.length < save.settings.rounds) return toast(`Need ${save.settings.rounds} cards to duel!`);
    duel = {round:1, pScore:0, aiScore:0, history:[], active:true, usedIds:[]};
    selDuelCard = null;
    renderDuel();
    renderDuelStrip();
    $('btn-duel-fight').disabled = true;
  }
  function renderDuel(){
    $('duel-round').textContent = `Round ${duel.round}/${save.settings.rounds}`;
    $('score-you').textContent = duel.pScore;
    $('score-ai').textContent = duel.aiScore;
    $('duel-dots').innerHTML = duel.history.map(x=>`<div class="round-dot ${x}"></div>`).join('');
    if(!selDuelCard) $('slot-you').innerHTML = '<span class="small">SELECT</span>';
    $('slot-ai').innerHTML = '<span class="small">OPPONENT</span>';
  }
  function renderDuelStrip(){
    const s = $('duel-strip');
    s.innerHTML = '';
    save.collection.forEach(c => {
      if(duel.usedIds.includes(c.id)) return;
      const t = getTemplate(c);
      const d = document.createElement('div');
      d.innerHTML = `<img src="${t.imageUrl}" style="width:60px;height:80px;object-fit:cover;border:1px solid #fff;border-radius:4px;">`;
      d.onclick = () => {
        selDuelCard = c;
        $('slot-you').innerHTML = `<img src="${t.imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
        $('btn-duel-fight').disabled = false;
      };
      s.appendChild(d);
    });
  }
  function resolveDuelRound(){
    if(!selDuelCard) return;
    duel.usedIds.push(selDuelCard.id);
    
    const stat = rand(save.stats);
    const aiC = createCard(rand(save.pool));
    $('slot-ai').innerHTML = `<img src="${getTemplate(aiC).imageUrl}" style="width:100%;height:100%;object-fit:cover;">`;
    const pVal = selDuelCard.stats[stat];
    const aiVal = Math.floor(aiC.stats[stat] * save.settings.aiScale);
    
    let res = 'tie';
    if(pVal>aiVal) { res='win'; duel.pScore++; }
    else if(aiVal>pVal) { res='loss'; duel.aiScore++; }
    
    duel.history.push(res);
    $('duel-msg').textContent = `${res.toUpperCase()}! ${stat} ${pVal} vs ${aiVal}`;
    
    renderDuelStrip();
    
    duel.round++;
    if(duel.round > save.settings.rounds){
      setTimeout(()=>{
        if(duel.pScore > duel.aiScore){
          toast("Victory! Card Won!");
          const c = createCard(rand(save.pool));
          save.collection.push(c);
          persist();
          renderCollection();
        } else toast("Defeat.");
        newDuel();
      }, 2000);
    } else {
      setTimeout(()=>{ selDuelCard=null; renderDuel(); $('duel-msg').textContent=''; }, 1500);
    }
  }
  
  function runBattle(){
    if(save.collection.length<2) return toast("Need 2+ cards");
    const log = $('battle-log'); log.innerHTML = '';
    let pool = [...save.collection].sort(()=>Math.random()-0.5);
    while(pool.length > 1){
      const a = pool.pop(); const b = pool.pop();
      const s = rand(save.stats);
      const win = a.stats[s]>=b.stats[s]?a:b;
      pool.unshift(win);
      log.innerHTML += `<div>${getTemplate(win).name} won</div>`;
    }
    toast(`Winner: ${getTemplate(pool[0]).name}! Card Won!`);
    save.collection.push(createCard(rand(save.pool))); persist(); renderCollection();
  }

  // --- COLLECTION & LAB ---
  function renderCollection(){
    const g = $('collection-grid');
    g.innerHTML = '';
    if(!save.collection.length) $('col-empty').classList.remove('hidden');
    else $('col-empty').classList.add('hidden');
    save.collection.forEach(c => {
      const t = getTemplate(c);
      const r = getRarity(c);
      const d = document.createElement('div');
      d.className = 'card-tile';
      d.onclick = () => openSheet(c);
      d.innerHTML = `<div class="card-img-wrap"><img src="${t.imageUrl}"></div><div class="rarity-badge" style="color:${r.color}">${r.name}</div><div class="card-body"><div class="card-name">${t.name}</div></div>`;
      g.appendChild(d);
    });
  }
  function openSheet(c){
    curSheetId = c.id;
    const t = getTemplate(c);
    const r = getRarity(c);
    $('sheet-name').textContent = t.name;
    $('sheet-img').innerHTML = `<img src="${t.imageUrl}">`;
    $('sheet-rarity').textContent = r.name;
    $('sheet-rarity').style.color = r.color;
    $('sheet-stats').innerHTML = save.stats.map(s=>`<span class="stat-pill">${s} ${c.stats[s]}</span>`).join('');
    $('sheet-layer').classList.add('active');
    const d = save.dialogues[c.id] || {};
    $('sheet-dialogue').innerHTML = `<li>Summon: ${d.summon||'-'}</li><li>Win: ${d.win||'-'}</li><li>Lose: ${d.lose||'-'}</li>`;
  }
  function closeSheet(){ $('sheet-layer').classList.remove('active'); }
  function deleteSheetCard(){
    // REMOVED CONFIRMATION HERE TOO
    save.collection = save.collection.filter(x=>x.id!==curSheetId);
    persist(); renderCollection(); closeSheet();
  }
  
  function renderDeckSelect(){
    const s = $('deck-select'); s.innerHTML='<option value="">Select Deck</option>';
    save.decks.forEach(d => s.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
  }
  function saveDeck(){
    const n = $('deck-input').value;
    if(n){ save.decks.push({id:uid(), name:n, cards:[]}); persist(); renderDeckSelect(); toast("Deck saved"); }
  }
  
  function setFusion(s){
    if(!save.collection.length) return toast("No cards");
    if(s==='a') fusion.a = save.collection[0];
    if(s==='b') fusion.b = save.collection[1] || save.collection[0];
    toast(`${s.toUpperCase()} Set`);
  }
  function runFusion(){
    if(fusion.a && fusion.b){
      const c = createCard(rand([getTemplate(fusion.a), getTemplate(fusion.b)]));
      save.collection.push(c); persist(); renderCollection(); toast("Fused!");
    }
  }
  
  function renderDialogSelect(){
    const s = $('dialog-card-select'); 
    s.innerHTML='<option value="">Select Card</option>';
    if(!save.collection.length) {
        s.innerHTML += '<option disabled>No Cards Available</option>';
        return;
    }
    save.collection.forEach(c => {
        s.innerHTML+=`<option value="${c.id}">${getTemplate(c).name} (${c.id.slice(0,4)})</option>`;
    });
  }
  function loadDialog(id){
    const d = save.dialogues[id] || {};
    $('inp-summon').value = d.summon||'';
    $('inp-win').value = d.win||'';
    $('inp-lose').value = d.lose||'';
  }
  function saveDialogue(){
    const id = $('dialog-card-select').value;
    if(id){
      save.dialogues[id] = {
        summon:$('inp-summon').value,
        win:$('inp-win').value,
        lose:$('inp-lose').value
      };
      persist(); toast("Saved");
    } else {
      toast("Select a card first");
    }
  }

  // --- SETTINGS EXPORTS ---
  function renderSettings(){
    $('stat-chips').innerHTML = save.stats.map((s,i)=>`<button class="btn sm ghost" onclick="app.remStat(${i})">${s} x</button>`).join('');
    $('rarity-list').innerHTML = save.rarities.map((r,i)=>`<div class="row space"><span class="small" style="color:${r.color}">${r.name}</span><input type="number" value="${r.factor}" step="0.1" style="width:60px" onchange="app.updRarity(${i},this.value)"></div>`).join('');
    $('inp-rounds').value = save.settings.rounds;
    $('inp-rng').value = save.settings.rng;
  }
  function addStat(){
    const v = $('stat-input').value;
    if(v && !save.stats.includes(v)){ save.stats.push(v); persist(); renderSettings(); }
  }
  function remStat(i){ save.stats.splice(i,1); persist(); renderSettings(); }
  function updRarity(i,v){ save.rarities[i].factor=parseFloat(v); persist(); }
  function updateRule(k,v){ save.settings[k]=parseInt(v); persist(); }
  
  function parsePool(){
    const lines = $('pool-area').value.split('\n');
    const p = [];
    lines.forEach(l=>{
      const m = l.match(/\[(.*?)\](.*)/);
      if(m) p.push({id:uid(), name:m[1], imageUrl:m[2]});
    });
    if(p.length){ save.pool=p; persist(); toast("Parsed!"); }
  }
  function loadDemoPool(){
    $('pool-area').value = `[Fire Drake]data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' fill='%23333'/><circle cx='32' cy='32' r='20' fill='%23f59e0b'/></svg>\n[Ice Golem]data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' fill='%231e293b'/><rect x='20' y='10' width='24' height='44' fill='%2338bdf8'/></svg>`;
  }
  function hardReset(){ if(confirm("Wipe?")){ localStorage.removeItem('df_v13'); location.reload(); } }
  function exportSave(){ 
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([JSON.stringify(save)],{type:'application/json'}));
    a.download = 'deckforge.json'; a.click();
  }
  function setWallpaper(){ save.wallpaper=$('wall-input').value; persist(); init(); }
  function toggleFullscreen(){
    if(!document.fullscreenElement){ document.documentElement.requestFullscreen(); }
    else { if(document.exitFullscreen) document.exitFullscreen(); }
  }

  function renderAll(){
    updateMeta(); renderCollection(); renderDeckSelect(); renderDialogSelect(); renderSettings();
    $('pool-area').value = save.pool.map(p=>`[${p.name}]${p.imageUrl}`).join('\n');
  }

  window.onload = init;

  return {
    setView, openMode, closePanels, openStarterBox, closePack,
    initPressure, startPressure, pressureTap,
    initDice, pickDiceCard, rollDice,
    initMemory, 
    newDuel, resolveDuelRound, runBattle,
    saveDeck, setFusion, runFusion, loadDialog, saveDialogue,
    addStat, remStat, updRarity, updateRule, parsePool, loadDemoPool, hardReset, exportSave, setWallpaper, toggleFullscreen,
    closeSheet, deleteSheetCard, toggleSheetDeck:()=>{toast("Deck Toggled")}
  };
})();
</script>
</body>
</html>

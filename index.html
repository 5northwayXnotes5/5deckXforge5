<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>DeckOS 4.6</title>
<!-- Phosphor Icons -->
<script src="https://unpkg.com/@phosphor-icons/web"></script>
<style>
/* --- SYSTEM VARIABLES --- */
:root {
  --bg-os: #000;
  --app-bg: #000;
  --panel-bg: #161618;
  --dock-bg: rgba(20, 20, 20, 0.4);
  --text-primary: #fff;
  --text-sec: #8e8e93;
  --separator: #2c2c2e;
  
  --accent-blue: #0A84FF;
  --accent-green: #30D158;
  --accent-red: #FF453A;
  --accent-orange: #FF9F0A;
  --accent-purple: #BF5AF2;
  --accent-gold: #FFD60A;
  
  --icon-size: 60px;
  --icon-radius: 14px;
  
  --font-sys: "SF Pro Display", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
html, body { height: 100%; width: 100%; overflow: hidden; margin: 0; background: #000; font-family: var(--font-sys); color: white; }

/* --- WALLPAPER --- */
#wallpaper {
  position: absolute; inset: -20px; z-index: 1;
  background: radial-gradient(circle at 50% 30%, #1a1f35, #000);
  background-size: cover; background-position: center;
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), filter 0.4s;
}
body.app-open #wallpaper { transform: scale(1.1); filter: blur(20px) brightness(0.4); }

/* --- STATUS BAR --- */
#status-bar {
  position: absolute; top: 0; left: 0; right: 0; height: 44px; z-index: 100;
  display: flex; justify-content: space-between; align-items: center;
  padding: 0 20px; font-size: 14px; font-weight: 600;
  color: white; pointer-events: none; text-shadow: 0 1px 4px rgba(0,0,0,0.5);
}
.currency-pill {
  background: rgba(0,0,0,0.3); backdrop-filter: blur(10px);
  padding: 4px 10px; border-radius: 12px;
  display: flex; align-items: center; gap: 6px;
  font-size: 12px; border: 1px solid rgba(255,255,255,0.05);
}

/* --- APP ICONS --- */
.app-grid {
  display: grid; grid-template-columns: repeat(4, 1fr); 
  gap: 20px 12px; padding: 20px 20px; margin-top: 50px; z-index: 10; position: relative;
  transition: opacity 0.3s, transform 0.3s;
}
body.app-open .app-grid { opacity: 0; pointer-events: none; transform: scale(1.1); }

.app-item { display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer; transition: transform 0.1s; }
.app-item:active { transform: scale(0.95); opacity: 0.8; }

.icon-box {
  width: var(--icon-size); height: var(--icon-size);
  border-radius: var(--icon-radius);
  display: flex; align-items: center; justify-content: center;
  font-size: 28px; color: white;
  box-shadow: 0 4px 10px rgba(0,0,0,0.4);
  position: relative; overflow: hidden;
  background: #222;
}
.icon-box::after { content:''; position: absolute; inset: 0; background: rgba(0,0,0,0.15); }
.icon-box i { z-index: 2; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
.app-name { font-size: 11px; font-weight: 500; color: #ddd; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }

/* Gradients */
.grad-duel { background: linear-gradient(135deg, #b92b27, #1565C0); }
.grad-royale { background: linear-gradient(135deg, #4b134f, #c94b4b); }
.grad-casino { background: linear-gradient(135deg, #16a085, #f4d03f); }
.grad-mem { background: linear-gradient(135deg, #e65c00, #F9D423); }
.grad-press { background: linear-gradient(135deg, #232526, #414345); border: 1px solid rgba(255,255,255,0.1); }
.grad-cards { background: linear-gradient(135deg, #1CB5E0, #000046); }
.grad-lab { background: linear-gradient(135deg, #56ab2f, #a8e063); }
.grad-store { background: linear-gradient(135deg, #8E2DE2, #4A00E0); }
.grad-set { background: linear-gradient(135deg, #304352, #d7d2cc); }

/* --- DOCK --- */
.dock-container {
  position: absolute; bottom: 24px; left: 16px; right: 16px;
  height: 84px; z-index: 10;
  background: var(--dock-bg);
  backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  border-radius: 28px;
  display: flex; align-items: center; justify-content: space-evenly;
  border: 1px solid rgba(255,255,255,0.05);
  transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
  box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}
body.app-open .dock-container { transform: translateY(200%); }

/* --- APP WINDOW --- */
.app-window {
  position: absolute; inset: 0; background: var(--app-bg);
  display: none; flex-direction: column;
  opacity: 0; transform: scale(0.95);
  transition: opacity 0.3s, transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  pointer-events: auto; z-index: 50;
}
.app-window.active { display: flex; opacity: 1; transform: scale(1); }

.nav-bar {
  height: 94px;
  padding: 44px 16px 10px; 
  display: flex; align-items: flex-end; justify-content: space-between;
  background: rgba(22,22,24,0.9); backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--separator); flex-shrink: 0;
}
.nav-title { font-size: 22px; font-weight: 700; color: white; line-height: 1; text-transform: uppercase; letter-spacing: 0.5px; }
.nav-gold { font-size: 14px; font-weight: 600; color: var(--accent-gold); display: flex; align-items: center; gap: 4px; background: rgba(255, 214, 10, 0.1); padding: 4px 8px; border-radius: 8px; margin-bottom: 2px; }

.content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: 40px; }

/* --- LISTS & INPUTS --- */
.list-group { margin: 16px; background: var(--panel-bg); border-radius: 10px; overflow: hidden; }
.list-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 16px; border-bottom: 0.5px solid var(--separator);
  font-size: 15px; color: white; min-height: 44px;
}
.list-row:last-child { border-bottom: none; }
.list-row label { font-weight: 500; color: #ddd; flex-shrink: 0; }
.list-sub { font-size: 12px; color: var(--text-sec); margin-top: 2px; }

select, input { 
  background: transparent; border: none; color: var(--accent-blue); 
  font-size: 15px; text-align: right; width: 60%; 
  font-family: inherit; height: 100%; display: block;
}
select:focus, input:focus { outline: none; }

.btn {
  background: var(--panel-bg); color: var(--accent-blue);
  font-size: 16px; font-weight: 600; padding: 12px;
  border-radius: 10px; margin: 8px 16px; text-align: center; cursor: pointer;
  transition: 0.1s; border: 1px solid rgba(255,255,255,0.05);
}
.btn:active { background: #2c2c2e; transform: scale(0.98); }
.btn.filled { background: var(--accent-blue); color: white; border:none; box-shadow: 0 2px 8px rgba(10, 132, 255, 0.2); }
.btn.gold { background: var(--accent-gold); color: black; border:none; box-shadow: 0 2px 8px rgba(255, 214, 10, 0.2); }
.btn.danger { color: var(--accent-red); }
.btn.sm { padding: 6px 12px; font-size: 13px; margin: 0; width: auto; display: inline-block; }

/* Compact buttons for sheet */
.btn-row { display: flex; gap: 8px; margin: 16px; }
.btn-row .btn { margin: 0; flex: 1; font-size: 14px; padding: 10px; }

/* --- SHOP --- */
.shop-grid { display: grid; grid-template-columns: 1fr; gap: 12px; padding: 16px; }
.shop-item {
  background: var(--panel-bg); border-radius: 14px; padding: 12px;
  display: flex; align-items: center; gap: 16px; cursor: pointer;
  border: 1px solid rgba(255,255,255,0.05);
}
.pack-icon {
  width: 50px; height: 70px; border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; color: rgba(255,255,255,0.9);
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  position: relative;
}
/* Pack Styles */
.p-basic { background: linear-gradient(135deg, #7f8c8d, #bdc3c7); }
.p-adv { background: linear-gradient(135deg, #16a085, #2ecc71); }
.p-elite { background: linear-gradient(135deg, #2980b9, #3498db); border: 1px solid #3498db; }
.p-comm { background: linear-gradient(135deg, #8e44ad, #9b59b6); border: 1px solid #9b59b6; }
.p-supr { background: linear-gradient(135deg, #e67e22, #f39c12); box-shadow: 0 0 10px rgba(243, 156, 18, 0.3); }
.p-myth { background: linear-gradient(135deg, #c0392b, #e74c3c); border: 1px solid #e74c3c; }
.p-god { background: linear-gradient(135deg, #000, #434343); border: 1px solid #FFD60A; box-shadow: 0 0 15px rgba(255, 214, 10, 0.4); color: #FFD60A; }

/* --- CASINO --- */
.casino-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px; }
.casino-game { 
  background: var(--panel-bg); height: 120px; border-radius: 16px;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 10px; cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
}
.casino-game i { font-size: 40px; color: var(--accent-gold); }
.casino-stage { padding: 20px; text-align: center; }

/* Slots */
.slot-machine {
  display: flex; gap: 10px; justify-content: center; margin: 20px 0;
  background: #111; padding: 15px; border-radius: 12px; border: 2px solid #333;
}
.reel {
  width: 70px; height: 100px; background: #222; border-radius: 6px; overflow: hidden;
  display: flex; align-items: center; justify-content: center; border: 1px solid #444;
}
.reel img { width: 100%; height: 100%; object-fit: cover; }

/* --- ROYALE --- */
.royale-bet-ui { padding: 20px; text-align: center; }
.royale-winner { 
  margin-top: 20px; padding: 20px; background: rgba(48, 209, 88, 0.1); 
  border-radius: 12px; border: 1px solid var(--accent-green); display: none; 
}

/* --- DUEL --- */
.game-stage {
  margin: 16px; padding: 20px;
  background: var(--panel-bg); border-radius: 16px;
  display: flex; flex-direction: column; align-items: center;
}
.duel-slots { display: flex; gap: 20px; margin: 20px 0; }
.card-slot { width: 90px; height: 130px; background: rgba(0,0,0,0.3); border: 2px dashed #444; border-radius: 10px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
.card-strip { display: flex; overflow-x: auto; gap: 12px; padding: 0 16px 20px; }
.strip-card { width: 60px; height: 90px; border-radius: 6px; flex-shrink: 0; background: #333; overflow: hidden; position: relative; }

/* --- OVERLAYS --- */
#home-bar {
  position: fixed; bottom: 0; left: 0; right: 0; height: 24px; z-index: 9999;
  display: flex; justify-content: center; align-items: center; cursor: pointer;
}
.bar-pill { width: 120px; height: 4px; background: white; border-radius: 2px; opacity: 0.5; }

.modal {
  position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px);
  display: none; align-items: center; justify-content: center; flex-direction: column;
}
.modal.active { display: flex; }

/* IOS Confirm */
.ios-confirm {
  width: 270px; background: rgba(30,30,30,0.9); backdrop-filter: blur(20px);
  border-radius: 14px; text-align: center; overflow: hidden;
}
.ios-confirm h3 { margin: 20px 0 5px; font-size: 17px; }
.ios-confirm p { margin: 0 20px 20px; font-size: 13px; color: #aaa; }
.ios-btns { display: flex; border-top: 0.5px solid #555; }
.ios-btn { flex: 1; padding: 12px; font-size: 17px; color: #0A84FF; cursor: pointer; border-right: 0.5px solid #555; }
.ios-btn:last-child { border: none; font-weight: 600; }
.ios-btn.destruct { color: #FF453A; }

.pack-open-anim { width: 200px; height: 280px; border-radius: 16px; background: white; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: 900; color: #000; box-shadow: 0 0 80px rgba(255,255,255,0.2); animation: shake 0.5s ease-in-out infinite; cursor: pointer; }
@keyframes shake{ 0%,100%{transform:rotate(0);} 25%{transform:rotate(3deg);} 75%{transform:rotate(-3deg);} }

.pack-grid { 
  display: grid; grid-template-columns: repeat(3, 1fr); 
  gap: 15px; width: 100%; max-width: 320px; margin-top: 20px; 
}
.pack-grid .card-thumb {
  aspect-ratio: 2/3; background: #222; border-radius: 8px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
}

.card-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 16px; }
.card-thumb { aspect-ratio: 2/3; background: #222; border-radius: 8px; position: relative; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
.card-thumb img { width: 100%; height: 100%; object-fit: cover; }
.rarity-tag { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; }

/* Toast */
.toast {
  position: fixed; top: -80px; left: 50%; transform: translateX(-50%); width: auto; min-width: 200px;
  background: rgba(40, 40, 40, 0.95); backdrop-filter: blur(20px);
  border-radius: 25px; z-index: 500; display: flex; align-items: center; justify-content: center; padding: 12px 24px; gap: 8px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  font-size: 14px; font-weight: 500;
}
.toast.show { top: 60px; }
.toast i { color: var(--accent-gold); }

.hidden { display: none !important; }
</style>
</head>
<body>

<div id="wallpaper"></div>

<div id="status-bar">
  <div id="clock">9:41</div>
  <div style="display:flex; gap:10px; align-items:center;">
    <div class="currency-pill">
      <i class="ph-fill ph-coins" style="color:var(--accent-gold)"></i>
      <span id="gold-display">0</span>
    </div>
    <div>
      <i class="ph-bold ph-wifi-high"></i>
      <i class="ph-bold ph-battery-full" style="margin-left:6px;"></i>
    </div>
  </div>
</div>

<!-- HOME SCREEN -->
<div class="app-grid">
  <div class="app-item" onclick="app.open('duel')">
    <div class="icon-box grad-duel"><i class="ph-fill ph-sword"></i></div>
    <div class="app-name">Duel</div>
  </div>
  <div class="app-item" onclick="app.open('royale')">
    <div class="icon-box grad-royale"><i class="ph-fill ph-crown"></i></div>
    <div class="app-name">Royale</div>
  </div>
  <div class="app-item" onclick="app.open('casino')">
    <div class="icon-box grad-casino"><i class="ph-fill ph-club"></i></div>
    <div class="app-name">Casino</div>
  </div>
  <div class="app-item" onclick="app.open('memory')">
    <div class="icon-box grad-mem"><i class="ph-fill ph-brain"></i></div>
    <div class="app-name">Memory</div>
  </div>
  <div class="app-item" onclick="app.open('pressure')">
    <div class="icon-box grad-press"><i class="ph-fill ph-gauge"></i></div>
    <div class="app-name">Pressure</div>
  </div>
</div>

<!-- DOCK -->
<div class="dock-container">
  <div class="app-item" onclick="app.open('collection')">
    <div class="icon-box grad-cards"><i class="ph-fill ph-cards"></i></div>
  </div>
  <div class="app-item" onclick="app.open('lab')">
    <div class="icon-box grad-lab"><i class="ph-fill ph-flask"></i></div>
  </div>
  <div class="app-item" onclick="app.open('shop')">
    <div class="icon-box grad-store"><i class="ph-fill ph-shopping-bag"></i></div>
  </div>
  <div class="app-item" onclick="app.open('settings')">
    <div class="icon-box grad-set"><i class="ph-fill ph-gear"></i></div>
  </div>
</div>

<!-- APPS -->
<div id="app-layer">

  <!-- DUEL -->
  <div id="app-duel" class="app-window">
    <div class="nav-bar">
      <div class="nav-title">Duel</div>
      <div class="nav-gold"><i class="ph-fill ph-coins"></i> +10</div>
    </div>
    <div class="content">
      <div class="game-stage">
        <div style="font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;" id="duel-round">Round 1</div>
        <div style="display:flex; justify-content:space-between; width:100%; padding:0 30px; font-size:32px; font-weight:800;">
          <span style="color:var(--accent-green)" id="score-you">0</span>
          <span style="color:var(--accent-red)" id="score-ai">0</span>
        </div>
        <div class="duel-slots">
          <div class="card-slot" id="slot-you"></div>
          <div style="display:flex; align-items:center; opacity:0.3; font-weight:900;">VS</div>
          <div class="card-slot" id="slot-ai"></div>
        </div>
        <div id="duel-msg" style="height:20px; color:var(--accent-orange); font-weight:600;"></div>
      </div>
      <div class="list-group">
        <div class="list-row">
          <label>Deck</label>
          <select id="duel-deck-filter" onchange="app.filterDuel()"><option value="">All Cards</option></select>
        </div>
      </div>
      <div class="card-strip" id="duel-strip"></div>
      <div class="btn filled" id="btn-duel-fight" onclick="app.resolveDuel()">FIGHT</div>
    </div>
  </div>

  <!-- SHOP -->
  <div id="app-shop" class="app-window">
    <div class="nav-bar"><div class="nav-title">Store</div><div class="nav-gold" id="shop-gold">0</div></div>
    <div class="content">
      <div class="shop-grid">
        <div class="shop-item" onclick="app.buyPack(0)">
          <div class="pack-icon p-basic"><i class="ph-fill ph-package"></i></div>
          <div style="flex:1"><div>Basic Pack</div><div class="list-sub">Starter cards.</div></div>
          <div class="btn gold sm">100 G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(1)">
          <div class="pack-icon p-adv"><i class="ph-fill ph-check-circle"></i></div>
          <div style="flex:1"><div>Advanced</div><div class="list-sub">Better odds.</div></div>
          <div class="btn gold sm">200 G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(2)">
          <div class="pack-icon p-elite"><i class="ph-fill ph-star"></i></div>
          <div style="flex:1"><div>Elite</div><div class="list-sub">Rare potential.</div></div>
          <div class="btn gold sm">500 G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(3)">
          <div class="pack-icon p-comm"><i class="ph-fill ph-medal"></i></div>
          <div style="flex:1"><div>Commander</div><div class="list-sub">Epic potential.</div></div>
          <div class="btn gold sm">1K G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(4)">
          <div class="pack-icon p-supr"><i class="ph-fill ph-crown"></i></div>
          <div style="flex:1"><div>Supreme</div><div class="list-sub">High value.</div></div>
          <div class="btn gold sm">2K G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(5)">
          <div class="pack-icon p-myth"><i class="ph-fill ph-lightning"></i></div>
          <div style="flex:1"><div>Mythic</div><div class="list-sub">Legendary chance.</div></div>
          <div class="btn gold sm">5K G</div>
        </div>
        <div class="shop-item" onclick="app.buyPack(6)">
          <div class="pack-icon p-god"><i class="ph-fill ph-infinity"></i></div>
          <div style="flex:1"><div>God Tier</div><div class="list-sub">The ultimate.</div></div>
          <div class="btn gold sm">20K G</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CASINO -->
  <div id="app-casino" class="app-window">
    <div class="nav-bar"><div class="nav-title">Casino</div></div>
    <div class="content">
      <div id="casino-home" class="casino-menu">
        <div class="casino-game" onclick="app.openCasinoGame('bj')">
          <i class="ph-fill ph-cards"></i>
          <span>Blackjack</span>
        </div>
        <div class="casino-game" onclick="app.openCasinoGame('roulette')">
          <i class="ph-fill ph-spinner"></i>
          <span>Roulette</span>
        </div>
        <div class="casino-game" onclick="app.openCasinoGame('slots')">
          <i class="ph-fill ph-rows"></i>
          <span>Slots</span>
        </div>
        <div class="casino-game" onclick="app.openCasinoGame('dice')">
          <i class="ph-fill ph-dice-two"></i>
          <span>Dice</span>
        </div>
      </div>

      <!-- GAME CONTAINERS -->
      <div id="cg-bj" class="hidden casino-stage">
        <h3>Blackjack (2:1)</h3>
        <div id="bj-table" style="min-height:100px; margin:20px 0;"></div>
        <div id="bj-controls">
           <div class="list-group"><div class="list-row"><label>Bet</label><input type="number" id="bj-bet" value="50"></div></div>
           <div class="btn filled" onclick="app.playBJ()">DEAL</div>
        </div>
        <div id="bj-actions" class="hidden" style="display:flex; gap:10px;">
           <div class="btn filled" style="flex:1" onclick="app.hitBJ()">HIT</div>
           <div class="btn danger" style="flex:1" onclick="app.standBJ()">STAND</div>
        </div>
        <div class="btn" onclick="app.backCasino()">Back</div>
      </div>

      <div id="cg-slots" class="hidden casino-stage">
         <h3>Slots</h3>
         <div class="slot-machine">
           <div class="reel" id="reel-1"></div>
           <div class="reel" id="reel-2"></div>
           <div class="reel" id="reel-3"></div>
         </div>
         <div class="list-group"><div class="list-row"><label>Bet</label><input type="number" id="slot-bet" value="50"></div></div>
         <div class="btn filled" onclick="app.spinSlots()">SPIN</div>
         <div class="btn" onclick="app.backCasino()">Back</div>
      </div>

      <div id="cg-roulette" class="hidden casino-stage">
         <h3>Roulette</h3>
         <div style="font-size:60px; font-weight:800; margin:30px 0; min-height:80px;" id="roul-res">?</div>
         <div style="display:flex; gap:10px; margin-bottom:20px;">
           <div class="btn danger" style="flex:1; margin:0;" onclick="app.spinRoulette('red')">RED (2x)</div>
           <div class="btn" style="flex:1; margin:0; background:#333; color:white;" onclick="app.spinRoulette('black')">BLACK (2x)</div>
         </div>
         <div class="list-group"><div class="list-row"><label>Bet</label><input type="number" id="roul-bet" value="50"></div></div>
         <div class="btn" onclick="app.backCasino()">Back</div>
      </div>

      <div id="cg-dice" class="hidden casino-stage">
         <h3>Lucky 7</h3>
         <div style="font-size:50px; margin:20px;" id="dice-disp">ðŸŽ² ðŸŽ²</div>
         <div style="display:flex; gap:10px;">
            <div class="btn" style="flex:1; margin:0;" onclick="app.rollDice('lo')">Low (&lt;7)</div>
            <div class="btn gold" style="flex:1; margin:0;" onclick="app.rollDice('7')">7 (4x)</div>
            <div class="btn" style="flex:1; margin:0;" onclick="app.rollDice('hi')">High (&gt;7)</div>
         </div>
         <div class="list-group"><div class="list-row"><label>Bet</label><input type="number" id="dice-bet" value="50"></div></div>
         <div class="btn" onclick="app.backCasino()">Back</div>
      </div>
    </div>
  </div>

  <!-- PRESSURE -->
  <div id="app-pressure" class="app-window">
    <div class="nav-bar"><div class="nav-title">Pressure</div></div>
    <div class="content" style="display:flex; flex-direction:column;">
      <div class="game-stage" style="flex:1; justify-content:center;">
        
        <div id="pressure-lobby">
           <div style="color:#888; margin-bottom:20px; text-align:center;">Survival Mode (10 Levels)<br>Fail = <b>Card Deleted</b></div>
           <div class="list-group"><div class="list-row"><label>Bet Amount</label><input type="number" id="pressure-bet" value="50"></div></div>
           <div class="btn gold" onclick="app.startPressure()">START RUN</div>
        </div>

        <div id="pressure-game" class="hidden" style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center;">
           <div style="font-size:16px; font-weight:700; color:var(--accent-blue); margin-bottom:10px;">LEVEL <span id="p-lvl">1</span>/10</div>
           
           <!-- Expanded Card Display -->
           <div style="flex:1; width:90%; background:#222; border-radius:12px; overflow:hidden; border:2px solid #444; margin-bottom:16px; position:relative; min-height:200px;">
              <div id="p-card-img" style="width:100%; height:100%;"></div>
              <div style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); padding:4px 8px; border-radius:4px; font-weight:700;" id="p-time">15.0s</div>
           </div>

           <!-- Bar -->
           <div style="width:100%; padding:0 10px; margin-bottom:16px;">
             <div style="height:14px; background:#333; border-radius:7px; overflow:hidden; position:relative;">
                <!-- Bar reduced to 10% width -->
                <div id="p-bar" style="position:absolute; top:0; bottom:0; left:50%; width:10%; transform:translateX(-50%); background:var(--accent-gold); border-radius:2px;"></div>
                <div style="position:absolute; left:0; width:3px; height:100%; background:red;"></div>
                <div style="position:absolute; right:0; width:3px; height:100%; background:red;"></div>
             </div>
           </div>

           <!-- Tap Area -->
           <button class="btn filled" onmousedown="app.pressureTap()" ontouchstart="app.pressureTap()" style="width:100%; height:60px; font-size:20px; margin:0; user-select:none; border-radius:12px;">PUSH</button>
           <div style="margin-top:8px; font-size:12px; color:#666;">Keep marker in bounds</div>
        </div>
      </div>
    </div>
  </div>

  <!-- COLLECTION -->
  <div id="app-collection" class="app-window">
    <div class="nav-bar"><div class="nav-title">Collection</div></div>
    <div class="content">
      <div class="card-grid" id="col-grid"></div>
      <div id="col-empty" style="text-align:center; margin-top:50px; color:#666;">No cards found.</div>
    </div>
  </div>

  <!-- SETTINGS -->
  <div id="app-settings" class="app-window">
    <div class="nav-bar"><div class="nav-title">Settings</div></div>
    <div class="content">
      <div class="list-group">
         <div class="list-row"><label>Wallpaper</label><input id="wall-in" placeholder="URL"></div>
         <div class="btn" onclick="app.setWall()">Update</div>
      </div>
      <div class="list-group">
         <div class="list-row"><label>Custom Stat</label><input id="stat-in"></div>
         <div class="btn" onclick="app.addStat()">Add</div>
         <div id="stat-list"></div>
      </div>
      <div class="list-group">
         <div class="list-row"><textarea id="pool-in" style="width:100%; height:80px; background:transparent; border:none; color:white; font-size:12px; font-family:monospace;" placeholder="[Name]URL"></textarea></div>
         <div class="btn" onclick="app.parsePool()">Update Pool</div>
         <div class="btn" onclick="app.loadDemo()">Load Default Data</div>
      </div>
      <div class="btn danger" onclick="app.askWipe()">Factory Reset</div>
    </div>
  </div>

  <!-- LAB -->
  <div id="app-lab" class="app-window">
    <div class="nav-bar"><div class="nav-title">Lab</div></div>
    <div class="content">
      <div class="list-group">
        <div class="list-row"><input id="deck-name" placeholder="New Deck Name" style="width:100%; text-align:left;"><div class="btn sm" onclick="app.saveDeck()">Save</div></div>
        <div class="list-row"><label>Active</label><select id="deck-sel" onchange="app.selDeck(this.value)"></select></div>
      </div>
      <div class="list-group">
        <div class="list-row"><select id="fuse-a" style="width:100%; text-align:left;"><option>Card A</option></select></div>
        <div class="list-row"><select id="fuse-b" style="width:100%; text-align:left;"><option>Card B</option></select></div>
      </div>
      <div class="btn filled" onclick="app.fuse()">FUSE</div>
    </div>
  </div>
  
  <!-- ROYALE -->
  <div id="app-royale" class="app-window">
    <div class="nav-bar"><div class="nav-title">Royale</div></div>
    <div class="content">
      <div class="royale-bet-ui">
        <div style="margin-bottom:20px; color:#aaa;">Bet on your champion.</div>
        <div class="list-group" style="margin:0 0 20px;">
           <div class="list-row"><label>Bet</label><input type="number" id="roy-bet" value="50"></div>
           <div class="list-row"><label>Champion</label><select id="roy-champ"></select></div>
        </div>
        <div class="btn filled" onclick="app.runRoyale()">START RACE</div>
        <div class="royale-winner" id="roy-win-box">
           <div style="font-weight:700; color:var(--accent-green);">WINNER</div>
           <div id="roy-win-name" style="font-size:20px; margin:10px 0;"></div>
           <div id="roy-win-img" style="width:80px; height:110px; background:#333; margin:0 auto; border-radius:8px; overflow:hidden;"></div>
           <div id="roy-payout" style="margin-top:10px; color:var(--accent-gold);"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- MEMORY -->
  <div id="app-memory" class="app-window">
    <div class="nav-bar">
      <div class="nav-title">Memory</div>
      <div class="btn sm" onclick="app.initMem()" style="margin:0;"><i class="ph-bold ph-arrow-counter-clockwise"></i></div>
    </div>
    <div class="content">
       <div id="mem-status" style="padding:10px 20px; text-align:center; font-size:13px; color:#888;">Entry: 20G &bull; Reward: 50G</div>
       <div class="card-grid" style="grid-template-columns:repeat(4,1fr); gap:8px;" id="mem-grid"></div>
    </div>
  </div>

</div>

<!-- GLOBAL OVERLAYS -->
<div id="home-bar" onclick="app.home()"><div class="bar-pill"></div></div>

<div class="modal" id="pack-modal">
   <div class="pack-open-anim" id="pack-opener">TAP</div>
   <div class="pack-grid" id="pack-reveal"></div>
   <div class="btn" id="pack-done" onclick="app.closePack()" style="display:none; margin-top:20px; width:200px; z-index:202;">Done</div>
</div>

<div class="modal" id="confirm-modal">
  <div class="ios-confirm">
    <h3>Factory Reset</h3>
    <p>Are you sure you want to wipe all data? This cannot be undone.</p>
    <div class="ios-btns">
      <div class="ios-btn" onclick="app.closeConfirm()">Cancel</div>
      <div class="ios-btn destruct" onclick="app.wipe()">Reset</div>
    </div>
  </div>
</div>

<div class="modal" id="sheet-modal" style="background:rgba(0,0,0,0.8); backdrop-filter:blur(5px); justify-content:flex-end; align-items:stretch;">
   <div style="background:#1c1c1e; border-radius:20px 20px 0 0; padding:24px; animation:slideUp 0.3s; display:flex; flex-direction:column; gap:8px;">
      <div style="display:flex; gap:16px;">
         <div id="sheet-img" style="width:110px; height:160px; background:#333; border-radius:10px; overflow:hidden; border:2px solid transparent;"></div>
         <div style="flex:1">
            <h2 id="sheet-name" style="margin:0 0 4px 0;">Name</h2>
            <div id="sheet-rarity" style="font-size:13px; font-weight:700; text-transform:uppercase; margin-bottom:12px;">Rarity</div>
            <div id="sheet-stats" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
         </div>
      </div>
      
      <!-- UPDATED BUTTON ROW -->
      <div class="btn-row" style="margin:16px 0 0;">
         <div class="btn filled" id="btn-deck-tog" onclick="app.togDeck()">+ Deck</div>
         <div class="btn danger" onclick="app.delCard()">Burn</div>
         <div class="btn" onclick="app.closeSheet()">Close</div>
      </div>
   </div>
</div>

<div class="toast" id="toast">
  <i class="ph-fill ph-bell"></i>
  <span id="toast-msg">Notification</span>
</div>

<style> @keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}} </style>

<script>
const app = (function(){
  const DEF = {
    ver: 4,
    gold: 100, 
    pool: [], col: [], decks: [], stats: ['ATK','DEF','SPD'],
    rarity: [
      {id:'c', n:'Common', c:'#8e8e93', w:500, lim:99},
      {id:'u', n:'Uncommon', c:'#30d158', w:250, lim:10},
      {id:'r', n:'Rare', c:'#0a84ff', w:100, lim:5},
      {id:'e', n:'Epic', c:'#bf5af2', w:25, lim:3},
      {id:'l', n:'Legendary', c:'#ffd60a', w:5, lim:1},
      {id:'m', n:'Mythic', c:'#ff453a', w:1, lim:1}
    ],
    wall: ''
  };
  
  const PACKS = [
    {c:100, w:[90,10,0,0,0,0]},
    {c:200, w:[70,25,5,0,0,0]},
    {c:500, w:[40,40,15,5,0,0]},
    {c:1000, w:[20,40,30,10,0,0]},
    {c:2000, w:[0,20,50,25,5,0]},
    {c:5000, w:[0,0,30,50,15,5]},
    {c:20000, w:[0,0,0,20,50,30]}
  ];

  let s = JSON.parse(JSON.stringify(DEF));
  
  // States
  let duel={a:false,r:1,ps:0,as:0,u:[],sel:null,deck:null};
  let press={a:false,l:null,bet:0,lvl:1,pos:50,card:null,force:0,time:15};
  let mem={l:false,g:[],f:null,c:0,a:0}; 
  let curC=null, curD=null;
  let bj={d:[],p:[],db:false,bet:0};

  const $ = id => document.getElementById(id);
  const uid = () => Math.random().toString(36).slice(2);
  const rand = a => a[Math.floor(Math.random()*a.length)];
  const notify = m => { $('toast-msg').innerText=m; $('toast').classList.add('show'); setTimeout(()=>$('toast').classList.remove('show'),3000); };
  
  function save(){ localStorage.setItem('dos_v4', JSON.stringify(s)); ui(); }
  function ui(){ 
    $('gold-display').innerText = s.gold.toLocaleString(); 
    $('shop-gold').innerText = s.gold.toLocaleString();
    $('col-empty').style.display = s.col.length ? 'none':'block';
  }

  function init(){
    const l = localStorage.getItem('dos_v4');
    if(l) { 
      const p=JSON.parse(l); 
      if(p.ver===4) s=p; 
      else { s.pool=p.pool||[]; s.col=p.collection||p.col||[]; s.gold=200; } 
    }
    if(s.wall) $('wallpaper').style.backgroundImage = `url('${s.wall}')`;
    setInterval(()=>{ const d=new Date(); $('clock').innerText=`${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`; },1000);
    ui();
  }

  function open(id){
    document.querySelectorAll('.app-window').forEach(e=>e.classList.remove('active'));
    $(`app-${id}`).classList.add('active');
    document.body.classList.add('app-open');
    if(id==='duel') initDuel();
    if(id==='collection') renderCol();
    if(id==='lab') initLab();
    if(id==='settings') initSet();
    if(id==='royale') initRoyale();
  }
  function home(){ 
    document.querySelectorAll('.app-window').forEach(e=>e.classList.remove('active'));
    document.body.classList.remove('app-open');
    if(press.l) clearInterval(press.l);
  }

  // --- CORE LOGIC ---
  function getRarityByWeight(wArr){
    const total = wArr.reduce((a,b)=>a+b,0);
    let r = Math.random() * total;
    for(let i=0; i<wArr.length; i++){
      if(r < wArr[i]) return s.rarity[i];
      r -= wArr[i];
    }
    return s.rarity[0];
  }

  function createCard(tid, rid){
    const t = s.pool.find(x=>x.id===tid);
    if(!t) return null;
    const rObj = s.rarity.find(x=>x.id===rid) || s.rarity[0];
    
    // Check Cap
    const existing = s.col.filter(c => c.tid===tid && c.rid===rid).length;
    if(existing >= rObj.lim) return 'CAP';

    const stat = {};
    const mult = s.rarity.indexOf(rObj) + 1;
    s.stats.forEach(k => stat[k] = Math.floor(Math.random()*20*mult) + (10*mult));
    return { id:uid(), tid, rid, stat };
  }

  // --- SHOP ---
  function buyPack(tierIdx){
    if(!s.pool.length) return notify("Pool Empty");
    const pack = PACKS[tierIdx];
    if(s.gold < pack.c) return notify("Insufficient Funds");
    s.gold -= pack.c; save();
    
    $('pack-modal').classList.add('active');
    $('pack-opener').style.display = 'flex'; $('pack-reveal').innerHTML=''; $('pack-done').style.display='none';
    
    $('pack-opener').onclick = () => {
       $('pack-opener').style.display='none';
       const cards = [];
       
       for(let i=0; i<3; i++) {
         const t = rand(s.pool);
         const r = getRarityByWeight(pack.w);
         const newC = createCard(t.id, r.id);
         
         if(newC === 'CAP') {
           s.gold += Math.floor(pack.c/5);
           notify(`Duplicate Burned (+${Math.floor(pack.c/5)}G)`);
         } else if(newC) {
           cards.push(newC);
         }
       }
       
       s.col.push(...cards); save();
       
       cards.forEach(c => {
         const t=s.pool.find(x=>x.id===c.tid); const r=s.rarity.find(x=>x.id===c.rid);
         const d=document.createElement('div'); d.className='card-thumb';
         d.innerHTML=`<img src="${t.img}"><div class="rarity-tag" style="background:${r.c}"></div>`;
         $('pack-reveal').appendChild(d);
       });
       if(cards.length===0) $('pack-reveal').innerHTML = '<div style="color:white; text-align:center; padding:20px; grid-column:span 3;">All cards converted to dust.<br>(Limits Reached)</div>';
       $('pack-done').style.display='block';
    }
  }
  function closePack(){ $('pack-modal').classList.remove('active'); }

  // --- CASINO ---
  function openCasinoGame(g){
    document.querySelectorAll('.casino-stage').forEach(e=>e.classList.add('hidden'));
    $(`cg-${g}`).classList.remove('hidden');
    $('casino-home').classList.add('hidden');
    if(g==='slots') renderReels();
  }
  function backCasino(){
    document.querySelectorAll('.casino-stage').forEach(e=>e.classList.add('hidden'));
    $('casino-home').classList.remove('hidden');
  }

  function playBJ(){
    const b = parseInt($('bj-bet').value);
    if(s.gold < b) return notify("No Gold");
    s.gold-=b; save(); bj.bet=b; bj.db=false;
    const deck = [2,3,4,5,6,7,8,9,10,10,10,10,11, 2,3,4,5,6,7,8,9,10,10,10,10,11]; 
    const draw = () => deck[Math.floor(Math.random()*deck.length)];
    bj.p = [draw(), draw()]; bj.d = [draw(), draw()];
    renderBJ();
    $('bj-controls').classList.add('hidden'); $('bj-actions').classList.remove('hidden');
  }
  function sumBJ(h){ let t=h.reduce((a,b)=>a+b,0); if(t>21 && h.includes(11)) t-=10; return t; }
  function renderBJ(){
    const t = $('bj-table');
    let dh = bj.db ? bj.d.join(' ') : `? ${bj.d[1]}`;
    t.innerHTML = `
      <div style="text-align:center; margin-bottom:10px;">Dealer: ${dh}</div>
      <div style="text-align:center; font-size:24px; font-weight:bold;">${bj.p.join(' ')} (${sumBJ(bj.p)})</div>
    `;
  }
  function hitBJ(){
    bj.p.push([2,3,4,5,6,7,8,9,10,10,10,10,11][Math.floor(Math.random()*13)]);
    renderBJ();
    if(sumBJ(bj.p)>21) endBJ(false);
  }
  function standBJ(){
    bj.db=true;
    while(sumBJ(bj.d)<17) bj.d.push([2,3,4,5,6,7,8,9,10,10,10,10,11][Math.floor(Math.random()*13)]);
    renderBJ();
    const p=sumBJ(bj.p), d=sumBJ(bj.d);
    if(d>21 || p>d) endBJ(true); else endBJ(false);
  }
  function endBJ(win){
    $('bj-actions').classList.add('hidden'); $('bj-controls').classList.remove('hidden');
    if(win) { s.gold += bj.bet*2; notify(`Won ${bj.bet*2}G`); } else notify("Lost");
    save();
  }

  function spinRoulette(choice){
    const b = parseInt($('roul-bet').value);
    if(s.gold < b) return notify("No Gold");
    s.gold-=b; save();
    $('roul-res').innerText = "Spinning...";
    $('roul-res').style.color = 'white';
    setTimeout(()=>{
      const n = Math.floor(Math.random()*37);
      const col = n===0 ? 'green' : (n%2===0 ? 'black':'red');
      $('roul-res').innerText = n; 
      $('roul-res').style.color = col === 'black' ? 'white' : col;
      if(choice===col) { s.gold += b*2; notify("WIN!"); } else notify("Lost");
      save();
    }, 1000);
  }

  function renderReels(){
     if(!s.pool.length) return;
     ['reel-1','reel-2','reel-3'].forEach(id => {
       $(id).innerHTML = `<img src="${rand(s.pool).img}">`;
     });
  }
  function spinSlots(){
    if(!s.pool.length) return notify("Pool Empty");
    const b = parseInt($('slot-bet').value);
    if(s.gold < b) return notify("No Gold");
    s.gold-=b; save();
    
    let spin = 0;
    const iv = setInterval(()=>{
       renderReels();
       spin++;
       if(spin > 10) {
         clearInterval(iv);
         const i1 = $('reel-1').querySelector('img').src;
         const i2 = $('reel-2').querySelector('img').src;
         const i3 = $('reel-3').querySelector('img').src;
         if(i1===i2 && i2===i3) { s.gold+=b*10; notify("JACKPOT! 10x"); }
         else if(i1===i2 || i2===i3 || i1===i3) { s.gold+=b*2; notify("Match! 2x"); }
         else notify("No Match");
         save();
       }
    }, 100);
  }
  
  function rollDice(type){
     const b = parseInt($('dice-bet').value);
     if(s.gold < b) return notify("No Gold");
     s.gold-=b; save();
     const r1 = Math.ceil(Math.random()*6);
     const r2 = Math.ceil(Math.random()*6);
     const sum = r1+r2;
     $('dice-disp').innerText = `${r1} + ${r2} = ${sum}`;
     let win = 0;
     if(type==='lo' && sum<7) win=b*2;
     if(type==='hi' && sum>7) win=b*2;
     if(type==='7' && sum===7) win=b*4;
     if(win>0){ s.gold+=win; notify(`Won ${win}`); } else notify("Lost");
     save();
  }

  // --- DUEL ---
  function initDuel(){ 
    const sel=$('duel-deck-filter'); sel.innerHTML='<option value="">All Cards</option>';
    s.decks.forEach(d=>sel.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
    duel.u=[]; duel.r=1; duel.ps=0; duel.as=0; duel.deck=null; duel.sel=null;
    renderDuel(); renderDuelStrip();
  }
  function filterDuel(){ duel.deck = $('duel-deck-filter').value; renderDuelStrip(); }
  function renderDuel(){
    $('score-you').innerText = duel.ps; $('score-ai').innerText = duel.as; $('duel-round').innerText = `Round ${duel.r}`;
    $('slot-you').innerHTML = duel.sel ? `<img src="${s.pool.find(x=>x.id===duel.sel.tid).img}" style="width:100%;height:100%;object-fit:cover;">` : '';
    $('slot-ai').innerHTML = '';
  }
  function renderDuelStrip(){
    const b = $('duel-strip'); b.innerHTML = '';
    let pool = s.col.filter(c=>!duel.u.includes(c.id));
    if(duel.deck) { const d=s.decks.find(x=>x.id===duel.deck); if(d) pool=pool.filter(c=>d.cards.includes(c.id)); }
    pool.forEach(c => {
      const t = s.pool.find(x=>x.id===c.tid); const r = s.rarity.find(x=>x.id===c.rid);
      const d = document.createElement('div'); d.className='strip-card';
      d.innerHTML = `<img src="${t.img}" style="width:100%;height:100%;object-fit:cover;"><div class="rarity-tag" style="background:${r.c}"></div>`;
      d.onclick = () => { duel.sel = c; renderDuel(); }
      b.appendChild(d);
    });
  }
  function resolveDuel(){
    if(!duel.sel) return;
    duel.u.push(duel.sel.id);
    const ai = createCard(rand(s.pool).id, 'r');
    if(ai === 'CAP') {/*ignore for AI*/} 
    
    if(ai && typeof ai !== 'string') {
        const aiT = s.pool.find(x=>x.id===ai.tid);
        $('slot-ai').innerHTML = `<img src="${aiT.img}" style="width:100%;height:100%;object-fit:cover;">`;
        const stat = rand(s.stats);
        const pV = duel.sel.stat[stat]; const aV = ai.stat[stat];
        if(pV > aV) { 
            duel.ps++; 
            $('duel-msg').innerText = `WIN (${stat}: ${pV} vs ${aV})`; 
        } else { 
            duel.as++; 
            $('duel-msg').innerText = `LOSS (${stat}: ${pV} vs ${aV})`; 
        }
    }

    duel.sel=null; 
    setTimeout(() => {
       duel.r++; if(duel.r > 3) {
         if(duel.ps > duel.as) { s.gold += 10; notify("Victory! +10G"); } else notify("Defeat");
         initDuel();
       } else { renderDuel(); renderDuelStrip(); $('duel-msg').innerText=""; }
       save();
    }, 1500);
  }

  // --- ROYALE (UPDATED 4.6: HOUSE CHALLENGERS) ---
  function initRoyale(){
    $('roy-win-box').style.display='none';
    const sel = $('roy-champ'); sel.innerHTML = '';
    // User needs at least 1 card to participate
    if(!s.col.length) { sel.innerHTML='<option>No Cards</option>'; return; }
    
    // Populate dropdown with unique card types from collection
    const unique = [...new Map(s.col.map(item => [item.tid, item])).values()];
    unique.forEach(c => {
       const t = s.pool.find(x=>x.id===c.tid);
       sel.innerHTML += `<option value="${c.tid}">${t.name}</option>`;
    });
  }

  function runRoyale(){
     if(!s.col.length) return notify("No Cards");
     const bet = parseInt($('roy-bet').value);
     if(s.gold < bet) return notify("No Gold");
     const pickTid = $('roy-champ').value;
     
     // 1. Find Player Champion (First instance of selected type)
     const playerCard = s.col.find(c => c.tid === pickTid);
     if(!playerCard) return notify("Card not found");

     s.gold -= bet; save();

     // 2. Create Participants: Player + 7 Bots
     let p = [playerCard];
     
     // Generate 7 House Bots
     for(let i=0; i<7; i++){
        // Random Template
        const t = rand(s.pool);
        // Random Rarity (Weighted: 50% Common, 30% Uncommon, 15% Rare, 4% Epic, 1% Legend)
        const r = getRarityByWeight([50,30,15,4,1,0]); 
        
        // Generate Bot Stats
        const stat = {};
        const mult = s.rarity.indexOf(r) + 1;
        s.stats.forEach(k => stat[k] = Math.floor(Math.random()*20*mult) + (10*mult));
        
        // Add Bot
        p.push({
            id: 'bot_'+i,
            tid: t.id,
            rid: r.id,
            stat: stat,
            isBot: true 
        });
     }

     // 3. Shuffle Positions
     p = p.sort(()=>Math.random()-.5);
     
     // 4. Run Tournament
     while(p.length > 1){
       const a=p.pop(), b=p.pop(), st=rand(s.stats);
       const w = a.stat[st] > b.stat[st] ? a : b;
       p.unshift(w);
     }
     
     const winner = p[0];
     const winT = s.pool.find(x=>x.id===winner.tid);
     const winR = s.rarity.find(x=>x.id===winner.rid);
     
     // 5. Display Result
     $('roy-win-box').style.display = 'block';
     $('roy-win-name').innerText = winT.name + (winner.isBot ? " (Bot)" : "");
     $('roy-win-img').innerHTML = `<img src="${winT.img}" style="width:100%;height:100%;object-fit:cover;">`;
     $('roy-win-img').style.border = `2px solid ${winR.c}`;
     
     // 6. Check Win (Compare IDs)
     if(winner.id === playerCard.id) {
        const payout = bet * 5;
        s.gold += payout;
        $('roy-payout').innerText = `You won ${payout}G!`;
        notify("Winner!");
     } else {
        $('roy-payout').innerText = "You lost the bet.";
     }
     save();
  }

  // --- PRESSURE 2.0 (UPDATED) ---
  function startPressure(){
    if(!s.col.length) return notify("No Cards");
    const bet = parseInt($('pressure-bet').value);
    if(s.gold < bet) return notify("Need Gold");
    
    s.gold -= bet; save();
    press = {
        a: true, 
        l: null, 
        bet: bet, 
        lvl: 1, 
        pos: 50, 
        card: rand(s.col), 
        // Initial force slightly higher
        force: 0.3,
        time: 15.0
    };
    
    $('pressure-lobby').classList.add('hidden'); 
    $('pressure-game').classList.remove('hidden');
    renderPressureFrame();
    
    press.l = setInterval(pressureLoop, 30);
  }
  
  function renderPressureFrame(){
      const t = s.pool.find(x=>x.id===press.card.tid);
      const r = s.rarity.find(x=>x.id===press.card.rid);
      $('p-card-img').innerHTML = `<img src="${t.img}" style="width:100%;height:100%;object-fit:cover;">`;
      $('p-card-img').parentElement.style.borderColor = r.c;
      $('p-lvl').innerText = press.lvl;
  }

  function pressureLoop(){
      press.time -= 0.03;
      if(press.time <= 0) {
          nextPressureLevel();
          return;
      }
      $('p-time').innerText = press.time.toFixed(1) + 's';

      // AGGRESSIVE DIFFICULTY CURVE
      // Level 1: 0.3 Force
      // Level 10: ~2.0 Force (Very hard to counter)
      // Base growth is slightly exponential
      const currentForce = press.force + (press.lvl * press.lvl * 0.02); 
      
      press.pos -= currentForce; 
      
      $('p-bar').style.left = press.pos + '%';

      // STRICTER BOUNDS: 0 to 90 (since bar width is 10%)
      if(press.pos <= 0 || press.pos >= 90) { 
          failPressure();
      }
  }

  function pressureTap(){
      if(press.a) {
          press.pos += 5; // Flat push strength
      }
  }

  function nextPressureLevel(){
      if(press.lvl >= 10) {
          const win = press.bet * press.lvl;
          s.gold += win;
          notify(`Survived! +${win}G`);
          endPressure();
          return;
      }
      
      const payout = press.bet * press.lvl;
      s.gold += payout;
      notify(`Level ${press.lvl} Complete! +${payout}G`);
      
      press.lvl++;
      press.time = 15.0;
      press.pos = 50;
      press.card = rand(s.col);
      renderPressureFrame();
      save();
  }

  function failPressure(){
      clearInterval(press.l);
      press.a = false;
      notify("FAILED! Card Lost.");
      s.col = s.col.filter(c => c.id !== press.card.id);
      save();
      setTimeout(endPressure, 1500);
  }

  function endPressure(){
      if(press.l) clearInterval(press.l);
      $('pressure-lobby').classList.remove('hidden'); 
      $('pressure-game').classList.add('hidden');
      renderCol(); 
  }

  // --- COLLECTION ---
  function renderCol(){
    const g = $('col-grid'); g.innerHTML = '';
    const sorted = [...s.col].sort((a,b) => {
       return s.rarity.findIndex(x=>x.id===b.rid) - s.rarity.findIndex(x=>x.id===a.rid);
    });
    sorted.forEach(c => {
      const t = s.pool.find(x=>x.id===c.tid); const r = s.rarity.find(x=>x.id===c.rid);
      const d = document.createElement('div'); d.className='card-thumb';
      d.innerHTML = `<img src="${t.img}"><div class="rarity-tag" style="background:${r.c}"></div>`;
      d.onclick = () => showSheet(c);
      g.appendChild(d);
    });
  }
  function showSheet(c){
    curC = c; const t = s.pool.find(x=>x.id===c.tid); const r = s.rarity.find(x=>x.id===c.rid);
    $('sheet-name').innerText = t.name; 
    $('sheet-rarity').innerText = r.n; $('sheet-rarity').style.color = r.c;
    $('sheet-img').innerHTML=`<img src="${t.img}" style="width:100%;height:100%;object-fit:cover;">`;
    $('sheet-img').style.borderColor = r.c;
    $('sheet-stats').innerHTML = Object.keys(c.stat).map(k=>`<span style="background:rgba(255,255,255,0.1);padding:4px 8px;border-radius:4px;font-size:12px;">${k}:${c.stat[k]}</span>`).join('');
    $('sheet-modal').classList.add('active');
    
    // Always show Deck toggle now (Requested)
    const btn = $('btn-deck-tog');
    if(curD) {
      const d = s.decks.find(x=>x.id===curD);
      btn.innerText = d.cards.includes(c.id) ? "- Deck" : "+ Deck";
      btn.className = d.cards.includes(c.id) ? "btn danger" : "btn filled";
      // btn.style.display = 'block'; // Always visible now
    } else { 
       btn.innerText = "Select Deck";
       btn.className = "btn";
    }
  }
  function closeSheet(){ $('sheet-modal').classList.remove('active'); }
  function delCard(){ 
    s.col = s.col.filter(x=>x.id!==curC.id); 
    s.gold += 10;
    save(); renderCol(); closeSheet(); 
  }
  function togDeck(){ 
    if(!curD) return notify("No Active Deck in Lab");
    const d = s.decks.find(x=>x.id===curD);
    if(d.cards.includes(curC.id)) d.cards = d.cards.filter(x=>x!==curC.id); else d.cards.push(curC.id);
    save(); showSheet(curC);
  }

  // --- LAB & SETTINGS ---
  function initLab(){
    const sl = $('deck-sel'); sl.innerHTML='<option value="">None</option>';
    s.decks.forEach(d=>sl.innerHTML+=`<option value="${d.id}">${d.name}</option>`);
    const fa=$('fuse-a'), fb=$('fuse-b'); fa.innerHTML='<option>A</option>'; fb.innerHTML='<option>B</option>';
    s.col.forEach(c=>{ const o=`<option value="${c.id}">${s.pool.find(x=>x.id===c.tid).name}</option>`; fa.innerHTML+=o; fb.innerHTML+=o; });
  }
  function saveDeck(){ const n=$('deck-name').value; if(n){ s.decks.push({id:uid(),name:n,cards:[]}); save(); initLab(); } }
  function selDeck(v){ curD = v; notify(v ? "Deck Selected" : "Deselected"); }
  function fuse(){
    const a=$('fuse-a').value, b=$('fuse-b').value;
    if(!a||!b||a===b) return notify("Invalid Fuse");
    const ca=s.col.find(x=>x.id===a), cb=s.col.find(x=>x.id===b);
    
    const base = Math.random()>.5 ? ca : cb;
    const nextRIdx = s.rarity.findIndex(x=>x.id===base.rid) + 1;
    if(nextRIdx >= s.rarity.length) return notify("Max Rarity");
    const newC = createCard(base.tid, s.rarity[nextRIdx].id);
    if(newC==='CAP') return notify("Rarity Cap Hit");
    
    s.col = s.col.filter(x=>x.id!==a && x.id!==b); 
    s.col.push(newC);
    save(); initLab(); notify("Fusion Successful!");
  }
  
  function initSet(){ 
    $('wall-in').value = s.wall; $('pool-in').value = s.pool.map(p=>`[${p.name}]${p.img}`).join('\n');
    $('stat-list').innerHTML = s.stats.map(k=>`<div class="list-row"><label>${k}</label><div class="btn danger sm" onclick="app.remStat('${k}')">X</div></div>`).join('');
  }
  function setWall(){ s.wall=$('wall-in').value; save(); init(); }
  function parsePool(){ 
    const p=[]; $('pool-in').value.split('\n').forEach(l=>{const m=l.match(/\[(.*?)\](.*)/); if(m) p.push({id:uid(),name:m[1],img:m[2]})});
    if(p.length){ s.pool=p; save(); notify("Pool Updated"); }
  }
  function loadDemo(){ 
     $('pool-in').value=`[Pikachu]https://img.icons8.com/color/96/pikachu-pokemon.png\n[Charmander]https://img.icons8.com/color/96/charmander.png\n[Squirtle]https://img.icons8.com/color/96/squirtle.png\n[Bulbasaur]https://img.icons8.com/color/96/bulbasaur.png\n[Gengar]https://img.icons8.com/color/96/gengar.png\n[Dragon]https://img.icons8.com/color/96/dragon.png\n[Knight]https://img.icons8.com/color/96/knight.png\n[Wizard]https://img.icons8.com/color/96/wizard.png`; 
     parsePool(); 
  }
  function askWipe(){ $('confirm-modal').classList.add('active'); }
  function closeConfirm(){ $('confirm-modal').classList.remove('active'); }
  function wipe(){ localStorage.clear(); location.reload(); }
  
  function addStat(){ const v=$('stat-in').value; if(v){ s.stats.push(v); save(); initSet(); } }
  function remStat(k){ s.stats=s.stats.filter(x=>x!==k); save(); initSet(); }

  // --- MEMORY (UPDATED 4.5) ---
  function initMem(){ 
     if(s.pool.length<2) return; 
     if(s.gold < 20) return notify("Entry Fee: 20G");
     s.gold -= 20; save();
     
     mem.c = 0; mem.f = null; mem.a = 0;
     $('mem-status').innerText = "Attempts: 0 | Pot: MAX"; // Reset text
     
     mem.g=[]; const g=$('mem-grid'); g.innerHTML=''; const set=[]; 
     for(let i=0;i<6;i++) set.push(rand(s.pool)); 
     [...set,...set].sort(()=>Math.random()-.5).forEach((t,i)=>{
        const d=document.createElement('div');d.className='card-thumb';
        d.onclick=()=>{
          if(d.innerHTML)return;
          d.innerHTML=`<img src="${t.img}">`;
          if(!mem.f)mem.f={d,t};
          else{
             // Second card clicked = 1 Attempt
             mem.a++;
             // Calc Multiplier
             let multi = 0;
             if(mem.a < 6) multi = "MAX"; // Absurd state
             else multi = Math.max(0, 10 - (mem.a - 6));
             $('mem-status').innerText = `Attempts: ${mem.a} | Pot: ${multi}x`;

             if(mem.f.t.id===t.id){
                mem.f=null;
                if(++mem.c===6){
                   const payout = (multi==="MAX" || multi > 10) ? 200 : (20 * multi);
                   if(payout > 0) { notify(`Won ${payout}G!`); s.gold+=payout; } 
                   else { notify("Too many attempts. 0G"); }
                   save();
                }
             }else{
                setTimeout(()=>{d.innerHTML='';mem.f.d.innerHTML='';mem.f=null;},500)
             }
          }
        };
        g.appendChild(d);
     }); 
  }

  window.onload = init;
  return { open, home, buyPack, closePack, initDuel, filterDuel, resolveDuel, startPressure, pressureTap, showSheet, closeSheet, delCard, togDeck, saveDeck, selDeck, fuse, setWall, parsePool, loadDemo, wipe, askWipe, closeConfirm, initMem, initRoyale, runRoyale, openCasinoGame, backCasino, playBJ, hitBJ, standBJ, spinRoulette, spinSlots, rollDice, addStat, remStat };
})();
</script>
</body>
</html>
